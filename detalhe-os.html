<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalhes da Ordem de Serviço</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth-guard.js" type="module"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f7f6; 
            color: #333; 
        }
        
        .page-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
        }

        .header-container {
            background-color: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
            margin-bottom: 20px;
        }

        .os-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 20px;
        }
        .my-info { 
            text-align: right; 
            font-size: 0.9rem; 
            color: #555;
        }
        .my-info p { margin: 2px 0; }
        .my-info strong { font-weight: 700; color: #333; }
        
        .os-title-container {
            text-align: center;
            width: 100%;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #eee;
        }
        .os-title { 
            font-size: 1.8rem; 
            font-weight: 700;
            margin: 0;
        }
        .archived-banner { 
            background-color: #7f8c8d; 
            color: white; 
            padding: 5px 15px; 
            border-radius: 15px; 
            font-size: 1rem; 
            font-weight: 700; 
            display: inline-block; 
            margin-left: 15px;
            vertical-align: middle;
        }
        .maintenance-type-details {
            font-size: 1rem;
            font-weight: 500;
            color: #555;
            margin-top: 8px;
            background-color: #f0f0f0;
            padding: 4px 10px;
            border-radius: 5px;
            display: inline-block;
        }

        .form-section { 
            background-color: #fff;
            border: 1px solid #e0e0e0; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.07);
        }
        .form-section h2 { 
            font-size: 1.2rem; 
            color: #3498db; 
            margin-top: 0; 
            margin-bottom: 15px; 
            border-bottom: 2px solid #3498db; 
            padding-bottom: 10px; 
        }
        .form-section p { 
            font-size: 1rem; 
            margin: 8px 0; 
            line-height: 1.6;
            color: #444;
        }
        .form-section p strong {
            font-weight: 500;
            color: #000;
        }
        
        .details-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 5px 20px; 
        }
        
        .signature-grid { 
            margin-top: 20px; 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 50px; 
            text-align: center; 
        }
        .signature-box img { 
            max-height: 80px; 
            margin-bottom: 10px; 
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .signature-line { 
            border-top: 1px solid #ccc; 
            margin: 0 20px; 
            padding-top: 8px; 
            font-weight: 500; 
            font-size: 0.9rem;
        }
        
        .actions-footer { 
            text-align: center; 
            margin-top: 20px; 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            padding-bottom: 20px;
        }
        .btn-action { text-decoration: none; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s ease; font-size: 1rem; }
        .btn-back { background-color: #7f8c8d; }
        .btn-pdf { background-color: #3498db; }
        .btn-pdf:disabled { background-color: #bdc3c7; }

        @media (max-width: 768px) {
            .page-container { padding: 10px; }
            .header-container, .form-section { padding: 15px; }
            .os-header { flex-direction: column; text-align: center; }
            .my-info { text-align: center; }
            .signature-grid { grid-template-columns: 1fr; gap: 30px 0; }
            .actions-footer { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div id="app-container">
        <!-- O conteúdo será renderizado aqui pelo JavaScript -->
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let currentOrderData = null;

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function renderPage(order) {
            const appContainer = document.getElementById('app-container');

            const formattedRetirada = formatDate(order.data_retirada || order.data_servico);
            const formattedDevolucao = formatDate(order.data_devolucao);
            const archivedBannerHtml = order.status === 'arquivada' ? `<span class="archived-banner">ARQUIVADA</span>` : '';
            
            let maintenanceTypeFullText = '';
            if (order.tipo_manutencao === 'preventiva') {
                maintenanceTypeFullText = 'MP - Manutenção Preventiva';
            } else if (order.tipo_manutencao === 'corretiva') {
                maintenanceTypeFullText = 'MC - Manutenção Corretiva';
            }

            let attendanceHtml = '';
            const ufpelContract = 'Contrato N° 03/2024';
            const capaoContract = 'Contrato Nº 138/2024';
            const exercitoContract = 'Contrato Nº 10/2025';

            if (order.contrato === ufpelContract) {
                attendanceHtml = `
                    <p><strong>Data do Serviço:</strong> ${formattedRetirada}</p>
                    <p><strong>Hora de Chegada:</strong> ${order.hora_chegada || 'N/A'}</p>
                    <p><strong>Hora de Saída:</strong> ${order.hora_saida || 'N/A'}</p>
                    <p><strong>Local do Atendimento:</strong> CME / HE-UFPEL</p>
                `;
            } else if (order.contrato === capaoContract || order.contrato === exercitoContract) {
                attendanceHtml = `
                    <p><strong>Data da Retirada / Serviço:</strong> ${formattedRetirada}</p>
                    <p><strong>Data da Devolução:</strong> ${formattedDevolucao}</p>
                    <p><strong>Local do Atendimento:</strong> ${order.local_atendimento || 'N/A'}</p>
                `;
            } else {
                attendanceHtml = `
                    <p><strong>Data da Retirada / Serviço:</strong> ${formattedRetirada}</p>
                    <p><strong>Data da Devolução:</strong> ${formattedDevolucao}</p>
                `;
            }

            let servicosRealizadosHtml;
            if (order.servicos_realizados === "Recebimento de equipamento para análise.") {
                servicosRealizadosHtml = `<p style="font-style: italic; color: #7f8c8d;">Equipamento recebido para análise. Nenhum serviço realizado ainda.</p>`;
            } else {
                servicosRealizadosHtml = `<p>${(order.servicos_realizados || 'Não informado.').replace(/\n/g, '<br>')}</p>`;
            }

            const pageHtml = `
            <div class="page-container">
                <div class="header-container">
                    <header class="os-header">
                        <div class="logo-container">
                            <img src="./images/logo.png" alt="Logo da Empresa" style="max-width: 250px;">
                        </div>
                        <div class="my-info">
                            <p><strong>BM MEDICAL</strong></p>
                            <p>Manutenção Hospitalar</p>
                            <p><strong>CNPJ:</strong> 48.673.158/0001-59</p>
                            <p>Av. Duque de Caxias, 915-B403, Pelotas-RS</p>
                            <p><strong>Fone:</strong> (51) 99377-5933</p>
                        </div>
                    </header>
                    <div class="os-title-container">
                        <div><h1 class="os-title">OS ${order.os_numero} ${archivedBannerHtml}</h1></div>
                        ${maintenanceTypeFullText ? `<div><p class="maintenance-type-details">${maintenanceTypeFullText}</p></div>` : ''}
                    </div>
                </div>
                
                <main>
                    <div class="form-section">
                        <h2>Dados do Cliente</h2>
                        <p><strong>Contrato:</strong> ${order.contrato || 'N/A'}</p>
                        <p><strong>Cliente:</strong> ${order.cliente || 'N/A'}</p>
                        <p><strong>Endereço:</strong> ${order.endereco || 'N/A'}</p>
                    </div>

                    <div class="form-section">
                        <h2>Dados do Equipamento</h2>
                        <p><strong>Equipamento:</strong> ${order.equipamento || 'N/A'}</p>
                        <div class="details-grid">
                            <p><strong>Marca:</strong> ${order.marca || 'N/A'}</p>
                            <p><strong>Modelo:</strong> ${order.modelo || 'N/A'}</p>
                            <p><strong>Serial:</strong> ${order.serial || 'N/A'}</p>
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Atendimento</h2>
                        <div class="details-grid">
                            ${attendanceHtml}
                        </div>
                    </div>

                    <div class="form-section">
                        <h2>Descrição dos Serviços Realizados</h2>
                        ${servicosRealizadosHtml}
                    </div>

                    <div class="form-section">
                        <h2>Peças Utilizadas</h2>
                        <p>${order.pecas_utilizadas || 'Nenhuma peça utilizada.'}</p>
                    </div>

                    <div class="form-section">
                        <h2>Assinaturas</h2>
                        <div class="signature-grid">
                            <div class="signature-box">
                                ${order.signature_data && order.signature_data.length > 200 ? `<img src="${order.signature_data}" alt="Assinatura do Responsável">` : '<p>(Sem assinatura)</p>'}
                                <div class="signature-line">Responsável do Setor</div>
                            </div>
                            <div class="signature-box">
                                <img src="./images/assinatura-tecnico.png" alt="Assinatura do Técnico">
                                <div class="signature-line">Responsável Técnico da Empresa</div>
                            </div>
                        </div>
                    </div>
                </main>

                <div class="actions-footer">
                    <a href="consultar-os.html" class="btn-action btn-back">❮ Voltar para a Consulta</a>
                    <button type="button" id="pdf-button" class="btn-action btn-pdf">Gerar PDF</button>
                </div>
            </div>
            `;
            appContainer.innerHTML = pageHtml;
        }

        async function loadOrderDetails() {
            const params = new URLSearchParams(window.location.search);
            const orderId = params.get('id');
            if (!orderId) {
                document.getElementById('app-container').innerHTML = '<h1>Erro: ID da OS não fornecido.</h1><a href="consultar-os.html">Voltar</a>';
                return;
            }
            try {
                const docRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) { throw new Error('OS não encontrada no banco de dados.'); }
                currentOrderData = docSnap.data();
                renderPage(currentOrderData);
                
                document.getElementById('pdf-button').addEventListener('click', generatePdf);

            } catch (error) {
                document.getElementById('app-container').innerHTML = `<h1>Erro: ${error.message}</h1><a href="consultar-os.html">Voltar</a>`;
            }
        }

        function imageToDataUrl(url, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => reject(new Error(`Falha ao carregar a imagem: ${url}. Erro: ${err}`));
                img.src = url;
            });
        }

        async function generatePdf() {
            const buttonElement = document.getElementById('pdf-button');
            if (!currentOrderData) { alert('Os dados da OS ainda não foram carregados.'); return; }
            buttonElement.disabled = true;
            buttonElement.textContent = 'Gerando...';
            try {
                const logoDataUrl = await imageToDataUrl('./images/logo.png', 0.9);
                const techSigDataUrl = await imageToDataUrl('./images/assinatura-tecnico.png', 0.7);
                const order = currentOrderData;
                const { jsPDF } = window.jspdf;
                const docPDF = new jsPDF();
                const pageHeight = docPDF.internal.pageSize.height;
                const pageWidth = docPDF.internal.pageSize.width;
                const margin = 15;
                let yPosition = 10;

                // --- Cabeçalho ---
                docPDF.addImage(logoDataUrl, 'JPEG', margin, yPosition, 72, 32);
                docPDF.setFontSize(8).setFont(undefined, 'normal');
                docPDF.text('BM MEDICAL', pageWidth - margin, yPosition + 5, { align: 'right' });
                docPDF.text('Manutenção Hospitalar', pageWidth - margin, yPosition + 9, { align: 'right' });
                docPDF.text('CNPJ: 48.673.158/0001-59', pageWidth - margin, yPosition + 13, { align: 'right' });
                docPDF.text('Av. Duque de Caxias, 915-B403, Pelotas-RS', pageWidth - margin, yPosition + 17, { align: 'right' });
                docPDF.text('Fone: (51) 99377-5933', pageWidth - margin, yPosition + 21, { align: 'right' });
                yPosition += 38;

                // --- Título da OS ---
                docPDF.setFontSize(20).setFont(undefined, 'bold');
                docPDF.text(`OS ${order.os_numero}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 8;

                if (order.tipo_manutencao) {
                    docPDF.setFontSize(12).setFont(undefined, 'normal');
                    const typeText = order.tipo_manutencao === 'preventiva' ? 'MP - Manutenção Preventiva' : 'MC - Manutenção Corretiva';
                    docPDF.text(typeText, pageWidth / 2, yPosition, { align: 'center' });
                }
                yPosition += 12;

                // --- Função para desenhar seções ---
                const drawSection = (title, contentCallback) => {
                    const startY = yPosition;
                    const contentY = startY + 10;
                    
                    const finalY = contentCallback(contentY, true); 
                    const contentHeight = finalY - contentY;
                    const boxHeight = contentHeight + 18; 
                    
                    docPDF.setDrawColor('#e0e0e0').setFillColor('#ffffff');
                    docPDF.roundedRect(margin, startY - 5, pageWidth - (margin * 2), boxHeight, 3, 3, 'FD');
                    
                    docPDF.setFontSize(14).setTextColor('#3498db').setFont(undefined, 'bold');
                    docPDF.text(title, margin + 4, startY);
                    docPDF.setDrawColor('#3498db').setLineWidth(0.5).line(margin + 4, startY + 2, pageWidth - margin - 4, startY + 2);

                    docPDF.setFontSize(12).setTextColor('#000000').setFont(undefined, 'normal');
                    contentCallback(contentY, false);

                    yPosition = startY + boxHeight + 3;
                };

                // --- Seções ---
                drawSection('Dados do Cliente', (currentY, isDryRun) => {
                    let y = currentY;
                    if (!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Contrato:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.contrato || 'N/A', margin + 27, y);
                        y += 6;
                        docPDF.setFont(undefined, 'bold').text('Cliente:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.cliente || 'N/A', margin + 27, y);
                        y += 6;
                        docPDF.setFont(undefined, 'bold').text('Endereço:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.endereco || 'N/A', margin + 27, y);
                    }
                    return y + 18;
                });

                drawSection('Dados do Equipamento', (currentY, isDryRun) => {
                    let y = currentY;
                    const equipLines = docPDF.splitTextToSize(order.equipamento || 'N/A', pageWidth - margin * 2 - 40);
                    if (!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Equipamento:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(equipLines, margin + 34, y);
                    }
                    y += 6 * equipLines.length;

                    if(!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Marca:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.marca || 'N/A', margin + 19, y);
                        docPDF.setFont(undefined, 'bold').text('Modelo:', margin + 70, y);
                        docPDF.setFont(undefined, 'normal').text(order.modelo || 'N/A', margin + 87, y);
                        docPDF.setFont(undefined, 'bold').text('Serial:', margin + 130, y);
                        docPDF.setFont(undefined, 'normal').text(order.serial || 'N/A', margin + 144, y);
                    }
                    return y + 6;
                });
                
                drawSection('Dados do Atendimento', (currentY, isDryRun) => {
                    const ufpelContract = 'Contrato N° 03/2024';
                    const capaoContract = 'Contrato Nº 138/2024';
                    const exercitoContract = 'Contrato Nº 10/2025';
                    let y = currentY;

                    if (order.contrato === ufpelContract) {
                        if (!isDryRun) {
                            docPDF.setFont(undefined, 'bold').text('Data do Serviço:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_servico), margin + 35, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Hora de Chegada:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(order.hora_chegada || 'N/A', margin + 35, y);
                            docPDF.setFont(undefined, 'bold').text('Hora de Saída:', margin + 80, y);
                            docPDF.setFont(undefined, 'normal').text(order.hora_saida || 'N/A', margin + 105, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Local:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text('CME / HE-UFPEL', margin + 20, y);
                        }
                        y += 6;
                    } else if (order.contrato === capaoContract || order.contrato === exercitoContract) {
                        if (!isDryRun) {
                            docPDF.setFont(undefined, 'bold').text('Data da Retirada:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_retirada), margin + 40, y);
                            docPDF.setFont(undefined, 'bold').text('Data da Devolução:', margin + 80, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_devolucao), margin + 120, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Local:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(order.local_atendimento || 'N/A', margin + 19, y);
                        }
                        y += 12;
                    }
                    return y;
                });

                drawSection('Descrição dos Serviços Realizados', (currentY, isDryRun) => {
                    const text = order.servicos_realizados || 'Não informado.';
                    const lines = docPDF.splitTextToSize(text, pageWidth - (margin * 2) - 8);
                    if (!isDryRun) docPDF.text(lines, margin + 4, currentY);
                    return currentY + (lines.length * 6);
                });

                drawSection('Peças Utilizadas', (currentY, isDryRun) => {
                    const text = order.pecas_utilizadas || 'Nenhuma.';
                    const lines = docPDF.splitTextToSize(text, pageWidth - (margin * 2) - 8);
                    if (!isDryRun) docPDF.text(lines, margin + 4, currentY);
                    return currentY + (lines.length * 6);
                });

                // --- Assinaturas (no final da página) ---
                const signatureY = pageHeight - 60;
                const signatureHeight = 25;
                const signatureWidth = 60;
                const roleY = signatureY + signatureHeight + 2;
                const lineY = roleY - 3;
                
                if (order.signature_data && order.signature_data.length > 200) {
                    docPDF.addImage(order.signature_data, 'JPEG', margin + 15, signatureY, signatureWidth, signatureHeight);
                }
                docPDF.setDrawColor('#333333').setLineWidth(0.3);
                docPDF.line(margin + 10, lineY, margin + 10 + signatureWidth + 10, lineY);
                docPDF.setFontSize(9).setFont(undefined, 'normal');
                docPDF.text('Responsável do Setor', margin + 45, roleY, { align: 'center' });

                const techSignatureX = pageWidth - margin - 15 - signatureWidth;
                docPDF.addImage(techSigDataUrl, 'JPEG', techSignatureX, signatureY, signatureWidth, signatureHeight);
                docPDF.line(techSignatureX - 5, lineY, techSignatureX + signatureWidth + 5, lineY);
                docPDF.text('Responsável Técnico da Empresa', techSignatureX + (signatureWidth/2), roleY, { align: 'center' });

                docPDF.save(`OS-${order.os_numero.split(' ')[0]}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF.");
            } finally {
                buttonElement.disabled = false;
                buttonElement.textContent = 'Gerar PDF';
            }
        }

        window.onload = loadOrderDetails;
    </script>
</body>
</html>
