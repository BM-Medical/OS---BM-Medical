<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadro de Ordens de Serviço</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth-guard.js" type="module"></script>
    <style>
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f4f7f6; color: #333; }
        .board-container { display: flex; flex-direction: column; height: 100vh; }
        .board-header { padding: 15px 20px; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 20px; position: sticky; top: 0; z-index: 10; }
        .board-header img { height: 40px; }
        .board-header h1 { font-size: 1.5rem; margin: 0; flex-grow: 1; }
        .board-header .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; }
        .board { display: flex; gap: 15px; padding: 20px; overflow-x: auto; flex-grow: 1; align-items: flex-start; }
        .list { background-color: #e9ecef; border-radius: 8px; width: 300px; min-width: 300px; max-height: 100%; display: flex; flex-direction: column; }
        .list[data-status="arquivada"] { background-color: #d6e9d6; }
        .list-header { padding: 12px 15px; font-weight: 700; font-size: 1rem; border-bottom: 1px solid #ced4da; position: sticky; top: 0; background-color: inherit; }
        .cards { padding: 10px; flex-grow: 1; min-height: 100px; overflow-y: auto; }
        .card { 
            background-color: #fff; 
            border-radius: 6px; 
            padding: 15px; 
            margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            cursor: grab; 
            position: relative; 
            user-select: none;
            touch-action: pan-y;
        }
        .card:active { cursor: grabbing; }
        .card.dragging { opacity: 0.5; }
        .card-icons { position: absolute; top: 8px; right: 8px; display: flex; gap: 8px; cursor: pointer; }
        .card-icon { display: none; }
        .card.is-signed .icon-signed { display: block; }
        .card.is-unsigned .icon-unsigned { display: flex; align-items: center; gap: 4px; }
        
        .icon-signed { width: 22px; height: 22px; }
        .icon-signed .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke-miterlimit: 10; stroke: #2ecc71; fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .icon-signed .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; stroke: #2ecc71; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        
        .placeholder {
            background: rgba(0,0,0,0.08);
            border-radius: 6px;
            margin-bottom: 10px;
            border: 2px dashed #999;
            box-sizing: border-box;
        }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; font-size: 2rem; font-weight: bold; cursor: pointer; border: none; background: none; }
        .modal-body .form-section { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .modal-body h2 { font-size: 1.2rem; color: #3498db; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .modal-body p, .modal-body .details-grid p { font-size: 1rem; margin: 5px 0; white-space: pre-wrap; }
        .modal-body .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 20px; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; font-weight: 500; margin-bottom: 5px; }
        .modal-body .form-group input, .modal-body .form-group textarea, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        .modal-footer { display: flex; justify-content: space-between; gap: 15px; margin-top: 20px; align-items: center; }
        .btn-action { text-decoration: none; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s ease; }
        .btn-edit { background-color: #f39c12; }
        .btn-pdf { background-color: #3498db; }
        .btn-pdf:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn-save { background-color: #2ecc71; }
        
        .signature-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .signature-modal-content { background-color: #fff; padding: 20px; border-radius: 10px; width: 95%; max-width: 600px; text-align: center; display: flex; flex-direction: column; }
        .signature-modal-content canvas { border: 2px dashed #ccc; border-radius: 6px; cursor: crosshair; width: 100%; height: 250px; }
        .signature-modal-buttons { margin-top: 15px; display: flex; justify-content: center; gap: 15px; flex-shrink: 0; }
        #signature-save-button-details { background-color: #2ecc71; color: white; }
        #signature-clear-button-details { background-color: #e74c3c; color: white; }
        #signature-cancel-button-details { background-color: #95a5a6; color: white; }
        #signature-error-message-details { color: #e74c3c; font-weight: 500; margin-top: 10px; display: none; }
        .signature-placeholder { border: 2px dashed #ccc; border-radius: 6px; padding: 20px; text-align: center; cursor: pointer; color: #7f8c8d; }
        .signature-thumbnail { max-width: 200px; max-height: 100px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }

        .signature-modal-overlay:fullscreen { background-color: #fff; }
        .signature-modal-overlay:fullscreen .signature-modal-content { height: 100%; width: 100%; max-width: none; border-radius: 0; padding: 15px; box-sizing: border-box; }
        .signature-modal-overlay:fullscreen .signature-modal-content canvas { flex-grow: 1; height: auto; }

        .ghost { position: absolute; pointer-events: none; opacity: 0.9; box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 100; transform: rotate(3deg); transition: transform 0.1s; }

        /* NOVO: Estilo para o painel de depuração */
        #debug-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 8px;
            border-radius: 5px;
            z-index: 9999;
            font-family: monospace;
            font-size: 12px;
            pointer-events: none;
            display: none; /* Começa escondido */
        }

        @media (max-width: 768px) {
            .board { scroll-snap-type: none; }
            .list { scroll-snap-align: none; }
        }
    </style>
</head>
<body>
    <!-- NOVO: Elemento para o painel de depuração -->
    <div id="debug-overlay"></div>

    <div class="board-container">
        <header class="board-header">
            <a href="index.html"><img src="./images/logo.png" alt="Logo BM Medical"></a>
            <h1>Quadro de Ordens de Serviço</h1>
            <button id="logout-button" class="logout-button">Sair</button>
        </header>

        <main class="board" id="board">
            <div class="list" data-status="novas"><div class="list-header">Novas OS</div><div class="cards"></div></div>
            <div class="list" data-status="aguardando_orcamento"><div class="list-header">Aguardando Orçamento</div><div class="cards"></div></div>
            <div class="list" data-status="aguardando_pecas"><div class="list-header">Aguardando Peças</div><div class="cards"></div></div>
            <div class="list" data-status="emissao_nota"><div class="list-header">Emissão de Nota</div><div class="cards"></div></div>
            <div class="list" data-status="pronto_entrega"><div class="list-header">Pronto para Entrega</div><div class="cards"></div></div>
            <div class="list" data-status="arquivada"><div class="list-header">Concluídas (Arquivar aqui)</div><div class="cards"></div></div>
        </main>
    </div>

    <!-- Modais (sem alterações) -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <button id="modal-close-button" class="modal-close">&times;</button>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    <div id="signature-modal-details" class="signature-modal-overlay">
        <div class="signature-modal-content">
            <h3>Assine no campo abaixo:</h3>
            <canvas id="signature-pad-details"></canvas>
            <p id="signature-error-message-details">Por favor, desenhe uma assinatura para salvar.</p>
            <div class="signature-modal-buttons">
                <button type="button" id="signature-save-button-details">Salvar</button>
                <button type="button" id="signature-clear-button-details">Limpar</button>
                <button type="button" id="signature-cancel-button-details">Cancelar</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const board = document.getElementById('board');
        const modalOverlay = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const modalCloseButton = document.getElementById('modal-close-button');
        const debugOverlay = document.getElementById('debug-overlay'); // NOVO
        
        let draggedCard = null;
        let ghostCard = null;
        let placeholder = null;
        let offsetX = 0;
        let offsetY = 0;
        let startX = 0;
        let startY = 0;
        let isDragging = false;
        let longPressTimer = null;
        let touchScrollAnimationId = null;
        let touchScrollSpeed = 0;

        function listenToOrders() {
            const q = query(collection(db, "orders"), where("status", "!=", "arquivada"));
            onSnapshot(q, (snapshot) => {
                const ordersByStatus = { novas: [], aguardando_orcamento: [], aguardando_pecas: [], emissao_nota: [], pronto_entrega: [] };
                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    if (typeof order.position === 'undefined') order.position = order.createdAt?.toMillis() || Date.now();
                    if (ordersByStatus[order.status]) ordersByStatus[order.status].push(order);
                });
                for (const status in ordersByStatus) {
                    const listContainer = document.querySelector(`.list[data-status="${status}"] .cards`);
                    const scrollTop = listContainer.scrollTop;
                    listContainer.innerHTML = '';
                    ordersByStatus[status]
                        .sort((a, b) => a.position - b.position)
                        .forEach(order => listContainer.appendChild(createCard(order)));
                    addDragAndDropListenersToContainer(listContainer);
                    listContainer.scrollTop = scrollTop;
                }
            });
        }

        function createCard(order) {
            const card = document.createElement('div');
            card.dataset.id = order.id;
            card.dataset.position = order.position;
            const isSigned = order.signature_data && typeof order.signature_data === 'string' && order.signature_data.length > 200;
            card.className = isSigned ? 'card is-signed' : 'card is-unsigned';
            card.innerHTML = `
                <div class="card-icons">
                    <div class="card-icon icon-signed"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>
                    <div class="card-icon icon-unsigned"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div>
                </div>
                <strong>${order.os_numero || 'N/A'}</strong>
                <p>${order.equipamento || 'N/A'}</p>
                <p>Data: ${order.data_servico || order.data_retirada || 'N/A'}</p>
            `;
            return card;
        }

        function addDragAndDropListenersToContainer(container) {
            container.querySelectorAll('.card').forEach(card => {
                if (card.dataset.listenersAttached) return;
                card.dataset.listenersAttached = 'true';
                card.addEventListener('mousedown', handleMouseDown);
                card.addEventListener('touchstart', handleTouchStart, { passive: true });
                card.addEventListener('touchend', handleTouchEnd);
                card.addEventListener('touchcancel', handleTouchEnd);
            });
        }

        // --- Lógica de Mouse (Desktop) ---
        function handleMouseDown(e) {
            if (e.target.closest('.card-icons')) return;
            draggedCard = this;
            startX = e.pageX;
            startY = e.pageY;
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);
        }

        function handleMouseMove(e) {
            e.preventDefault();
            if (!isDragging && (Math.abs(e.pageX - startX) > 5 || Math.abs(e.pageY - startY) > 5)) {
                initiateDragVisuals(draggedCard, startX, startY);
            }
            if (isDragging) {
                moveDrag(e.pageX, e.pageY, e.clientX, e.clientY);
            }
        }

        function handleMouseUp() {
            if (isDragging) dropCard();
            else if (draggedCard) openDetailsModal(draggedCard.dataset.id);
            cleanupAfterDrag();
            document.removeEventListener('mousemove', handleMouseMove);
            document.removeEventListener('mouseup', handleMouseUp);
        }

        // --- Lógica de Toque (Mobile) ---
        function handleTouchStart(e) {
            if (e.target.closest('.card-icons')) return;
            const touch = e.touches[0];
            draggedCard = this;
            startX = touch.pageX;
            startY = touch.pageY;
            clearTimeout(longPressTimer);
            longPressTimer = setTimeout(() => {
                document.addEventListener('touchmove', handleTouchMove, { passive: false });
                longPressTimer = null; 
            }, 200);
        }

        function handleTouchMove(e) {
            if (!draggedCard || longPressTimer) return;
            e.preventDefault();
            const touch = e.touches[0];
            if (!isDragging) {
                initiateDragVisuals(draggedCard, startX, startY);
                debugOverlay.style.display = 'block'; // NOVO: Mostra o debug
            }
            if (isDragging) {
                moveDrag(touch.pageX, touch.pageY, touch.clientX, touch.clientY);
                handleTouchAutoScroll(touch.clientX);
                // NOVO: Atualiza o debug
                debugOverlay.textContent = `clientX: ${Math.round(touch.clientX)} | speed: ${touchScrollSpeed}`;
            }
        }

        function handleTouchEnd() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                if (draggedCard) openDetailsModal(draggedCard.dataset.id);
            } else if (isDragging) {
                dropCard();
            }
            cleanupAfterDrag();
            document.removeEventListener('touchmove', handleTouchMove);
        }
        
        // --- Funções Comuns de Drag & Drop ---
        function initiateDragVisuals(element, pageX, pageY) {
            if (!element || isDragging) return;
            isDragging = true;
            const rect = element.getBoundingClientRect();
            offsetX = pageX - rect.left;
            offsetY = pageY - rect.top;
            ghostCard = element.cloneNode(true);
            ghostCard.classList.add('ghost');
            ghostCard.style.width = `${rect.width}px`;
            ghostCard.style.height = `${rect.height}px`;
            document.body.appendChild(ghostCard);
            placeholder = document.createElement('div');
            placeholder.classList.add('placeholder');
            placeholder.style.height = `${rect.height}px`;
            element.classList.add('dragging');
            element.parentElement.insertBefore(placeholder, element);
            const clientX = pageX - window.scrollX;
            const clientY = pageY - window.scrollY;
            moveDrag(pageX, pageY, clientX, clientY);
        }
        
        function moveDrag(pageX, pageY, clientX, clientY) {
            if (!isDragging || !ghostCard) return;
            ghostCard.style.left = `${pageX - offsetX}px`;
            ghostCard.style.top = `${pageY - offsetY}px`;

            // ALTERAÇÃO: Técnica robusta de detecção
            ghostCard.style.display = 'none';
            const targetListContainer = document.elementFromPoint(clientX, clientY)?.closest('.cards');
            ghostCard.style.display = ''; // Volta ao padrão

            if (targetListContainer) {
                const afterElement = getDragAfterElement(targetListContainer, clientY);
                if (afterElement) {
                    targetListContainer.insertBefore(placeholder, afterElement);
                } else {
                    targetListContainer.appendChild(placeholder);
                }
            }
        }

        function cleanupAfterDrag() {
            if (touchScrollAnimationId) {
                cancelAnimationFrame(touchScrollAnimationId);
                touchScrollAnimationId = null;
            }
            if (ghostCard) ghostCard.remove();
            if (draggedCard) {
                if (placeholder && placeholder.parentElement) {
                    placeholder.parentElement.insertBefore(draggedCard, placeholder);
                }
                draggedCard.classList.remove('dragging');
            }
            if(placeholder) placeholder.remove();
            debugOverlay.style.display = 'none'; // NOVO: Esconde o debug
            ghostCard = null;
            placeholder = null;
            draggedCard = null;
            isDragging = false;
        }

        function dropCard() {
            if (!placeholder || !placeholder.parentElement || !draggedCard) return;
            const parentList = placeholder.parentElement;
            const newStatus = parentList.parentElement.dataset.status;
            const prevElement = placeholder.previousElementSibling;
            const nextElement = placeholder.nextElementSibling;
            const prevPosition = prevElement ? parseFloat(prevElement.dataset.position) : 0;
            const nextPosition = nextElement ? parseFloat(nextElement.dataset.position) : (prevPosition + 200000);
            const newPosition = (prevPosition + nextPosition) / 2;
            updateOrder(draggedCard.dataset.id, newStatus, newPosition);
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.card:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) return { offset: offset, element: child };
                else return closest;
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function updateOrder(orderId, newStatus, newPosition) {
            const orderRef = doc(db, "orders", orderId);
            try {
                await updateDoc(orderRef, { status: newStatus, position: newPosition });
            } catch (error) {
                console.error("Erro ao atualizar a OS:", error);
            }
        }
        
        function handleTouchAutoScroll(clientX) {
            const scrollZone = 50; 
            const viewportWidth = window.innerWidth;
            if (clientX < scrollZone) {
                touchScrollSpeed = -5; // Aumentei um pouco a velocidade
                if (!touchScrollAnimationId) touchScrollAnimationId = requestAnimationFrame(animateTouchScroll);
            } else if (clientX > viewportWidth - scrollZone) {
                touchScrollSpeed = 5; // Aumentei um pouco a velocidade
                if (!touchScrollAnimationId) touchScrollAnimationId = requestAnimationFrame(animateTouchScroll);
            } else {
                touchScrollSpeed = 0;
            }
        }

        function animateTouchScroll() {
            if (touchScrollSpeed !== 0) {
                board.scrollLeft += touchScrollSpeed;
                touchScrollAnimationId = requestAnimationFrame(animateTouchScroll);
            } else {
                cancelAnimationFrame(touchScrollAnimationId);
                touchScrollAnimationId = null;
            }
        }

        // --- Código dos Modais e PDF (sem alterações) ---
        async function openDetailsModal(orderId) { /* ...código existente... */ }
        function generateDetailsView(order) { /* ...código existente... */ }
        window.switchToEditMode = async function(orderId) { /* ...código existente... */ }
        function generateEditForm(order) { /* ...código existente... */ }
        async function saveOrderChanges(orderId) { /* ...código existente... */ }
        // Funções de assinatura...
        // Funções de PDF...

        // Cole aqui as funções dos modais e PDF da versão anterior para economizar espaço
        // Exemplo:
        async function openDetailsModal(orderId) {
            if (isDragging) return;
            try {
                const docRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error('OS não encontrada');
                const order = { id: docSnap.id, ...docSnap.data() };
                modalBody.innerHTML = generateDetailsView(order);
                modalOverlay.style.display = 'flex';
            } catch (error) {
                console.error("Erro ao abrir detalhes:", error);
                alert(`Erro ao buscar detalhes: ${error.message}`);
            }
        }
        function generateDetailsView(order) {
            const isSigned = order.signature_data && order.signature_data.length > 200;
            let signatureSectionHtml = isSigned
                ? `<img src="${order.signature_data}" class="signature-thumbnail" alt="Assinatura">`
                : `<div class="signature-placeholder">Sem Assinatura</div>`;
            return `
                <h1>Detalhes da OS: ${order.os_numero}</h1>
                <div class="form-section"><h2>Dados do Cliente</h2><p><strong>Contrato:</strong> ${order.contrato||'N/A'}</p><p><strong>Cliente:</strong> ${order.cliente||'N/A'}</p><p><strong>Endereço:</strong> ${order.endereco||'N/A'}</p></div>
                <div class="form-section"><h2>Dados do Equipamento</h2><p><strong>Equipamento:</strong> ${order.equipamento||'N/A'}</p><p><strong>Marca:</strong> ${order.marca||'N/A'}</p><p><strong>Modelo:</strong> ${order.modelo||'N/A'}</p><p><strong>Serial:</strong> ${order.serial||'N/A'}</p></div>
                <div class="form-section"><h2>Atendimento</h2><p><strong>Data da Retirada / Serviço:</strong> ${order.data_retirada||order.data_servico||'N/A'}</p><p><strong>Data da Devolução:</strong> ${order.data_devolucao||'N/A'}</p><p><strong>Hora de Chegada:</strong> ${order.hora_chegada||'N/A'}</p><p><strong>Hora de Saída:</strong> ${order.hora_saida||'N/A'}</p><p><strong>Local do Atendimento:</strong> ${order.local_atendimento||'N/A'}</p></div>
                <div class="form-section"><h2>Serviços e Peças</h2><p><strong>Serviços Realizados:</strong><br>${(order.servicos_realizados||'').replace(/\n/g,'<br>')}</p><p><strong>Peças Utilizadas:</strong><br>${order.pecas_utilizadas||'Nenhuma'}</p></div>
                <div class="form-section"><h2>Assinaturas</h2><div class="signature-grid"><div class="signature-box"><label>Responsável do Setor:</label><div id="signature-container-details">${signatureSectionHtml}</div></div><div class="signature-box"><label>Responsável Técnico:</label><img src="./images/assinatura-tecnico.png" style="max-width:200px;"></div></div></div>
                <div class="modal-footer"><button class="btn-action btn-edit" onclick="window.switchToEditMode('${order.id}')">Editar OS</button><button class="btn-action btn-pdf" onclick="window.generatePdfFromModal('${order.id}', this)">Gerar PDF</button></div>`;
        }
        
        modalCloseButton.addEventListener('click', () => modalOverlay.style.display = 'none');
        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) modalOverlay.style.display = 'none';
        });


        // --- Inicialização ---
        listenToOrders();

    </script>
</body>
</html>