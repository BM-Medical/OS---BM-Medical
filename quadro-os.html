<!-- ... existing code ... -->
    <div id="toast-notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, onSnapshot, query, where, orderBy, deleteField, arrayUnion } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { SignaturePadManager } from './signature-pad-helper.js';
        import { generateOsPdf } from './pdf-generator.js';
        import { PartsManager } from './modulo-pecas.js';
        import { EquipmentSelector } from './equipment-selector.js';
        import { escapeHTML } from './security-helpers.js'; // IMPORTA A NOVA FUNÇÃO

        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
<!-- ... existing code ... -->
        function generateDetailsView(order) {
            const isSigned = order.signature_data && order.signature_data.length > 200;
            let signatureSectionHtml = isSigned
                ? `<img src="${order.signature_data}" class="signature-thumbnail" alt="Assinatura">`
                : `<div class="signature-placeholder">Sem Assinatura</div>`;
            
            let servicosDisplayHtml;
            if (order.servicos_realizados === "Recebimento de equipamento para análise.") {
                servicosDisplayHtml = `<p><strong>Serviços Realizados:</strong></p><p style="font-style: italic; color: #7f8c8d;">Equipamento recebido para análise.</p>`;
            } else {
                const safeServicesText = escapeHTML(order.servicos_realizados || 'Não informado.');
                servicosDisplayHtml = `<p><strong>Serviços Realizados:</strong><br>${safeServicesText.replace(/\n/g, '<br>')}</p>`;
            }

            let pecasHtml = '<p>Nenhuma peça utilizada.</p>';
            if (order.pecas_utilizadas && Array.isArray(order.pecas_utilizadas) && order.pecas_utilizadas.length > 0) {
                pecasHtml = '<ul class="list-disc pl-5 space-y-1">';
                order.pecas_utilizadas.forEach(part => {
                    pecasHtml += `<li><strong>${part.qtd}x</strong> - ${escapeHTML(part.descricao)}</li>`;
                });
                pecasHtml += '</ul>';
            } else if (order.pecas_utilizadas && typeof order.pecas_utilizadas === 'string') {
                const safePartsText = escapeHTML(order.pecas_utilizadas);
                pecasHtml = `<p>${safePartsText.replace(/\n/g, '<br>')}</p>`;
            }


            const formattedRetirada = formatDate(order.data_servico || order.data_retirada);
            const formattedDevolucao = formatDate(order.data_devolucao);
<!-- ... existing code ... -->
