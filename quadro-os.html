<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadro de Ordens de Serviço</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth-guard.js" type="module"></script>
    <style>
        /* ESTILOS GERAIS E DO QUADRO */
        html, body {
            overflow: hidden;
            height: 100%;
        }
        body { font-family: 'Inter', sans-serif; margin: 0; background-color: #f4f7f6; color: #333; }
        .board-container { display: flex; flex-direction: column; height: 100vh; }
        .board-header { 
            padding: 15px 20px; 
            background-color: #fff; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
            display: flex; 
            align-items: center; 
            gap: 20px; 
            position: sticky; 
            top: 0; 
            z-index: 10;
        }
        .board-header img { height: 40px; }
        .board-header h1 { font-size: 1.5rem; margin: 0; flex-grow: 1; }
        .board-header .logout-button { background-color: #e74c3c; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-weight: 500; margin-left: auto; }
        
        /* ESTILOS DA LEGENDA */
        .header-legend {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: 20px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            font-weight: 500;
            color: #555;
        }
        .legend-color-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .board { 
            display: flex; 
            gap: 15px; 
            padding: 20px 20px 60px 20px; 
            overflow-x: auto; 
            flex-grow: 1; 
            align-items: flex-start;
            box-sizing: border-box; 
            touch-action: pan-x pan-y;
        }

        .list { background-color: #e9ecef; border-radius: 8px; width: 300px; min-width: 300px; max-height: 100%; display: flex; flex-direction: column; }
        .list-header { padding: 12px 15px; font-weight: 700; font-size: 1rem; border-bottom: 1px solid #ced4da; position: sticky; top: 0; background-color: inherit; z-index: 2; }
        .cards { padding: 10px; flex-grow: 1; min-height: 100px; overflow-y: auto; }
        
        /* ESTILOS DO CARTÃO (CARD) */
        .card { 
            background-color: #fff; 
            border-radius: 6px; 
            padding: 15px; 
            padding-bottom: 40px;
            margin-bottom: 10px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); 
            cursor: pointer; 
            position: relative; 
            user-select: none;
            border-left: 5px solid transparent; 
            transition: box-shadow 0.2s ease-in-out;
        }
        .card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.12);
        }
        .card strong {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            padding-right: 45px;
        }
        .card p {
            margin: 0;
            font-size: 0.9rem;
            color: #6c757d;
        }
        /* NOVO ESTILO PARA TIPO DE MANUTENÇÃO NO CARD */
        .maintenance-type-card {
            position: absolute;
            bottom: 8px;
            left: 15px;
            font-size: 1.1rem;
            font-weight: 700;
            color: #e74c3c;
        }

        /* ÍCONES DE STATUS (ASSINATURA) */
        .card-status-icon {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            align-items: center;
        }
        .icon-signed { width: 22px; height: 22px; }
        .icon-signed .checkmark__circle { stroke-dasharray: 166; stroke-dashoffset: 166; stroke-width: 3; stroke-miterlimit: 10; stroke: #2ecc71; fill: none; animation: stroke .6s cubic-bezier(0.65, 0, 0.45, 1) forwards; }
        .icon-signed .checkmark__check { transform-origin: 50% 50%; stroke-dasharray: 48; stroke-dashoffset: 48; stroke-width: 4; stroke: #2ecc71; animation: stroke .3s cubic-bezier(0.65, 0, 0.45, 1) .8s forwards; }
        @keyframes stroke { 100% { stroke-dashoffset: 0; } }
        .icon-unsigned { display: flex; align-items: center; gap: 4px; }

        /* SISTEMA DE MOVER */
        .card-move-action {
            position: absolute;
            bottom: 8px;
            right: 8px;
        }
        .card-move-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        .card-move-icon:hover {
            background-color: #e0e0e0;
        }
        .card-move-icon svg {
            width: 20px;
            height: 20px;
            fill: #6c757d;
        }
        
        .move-menu {
            display: none;
            position: fixed;
            background-color: #fff;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1100;
            padding: 5px 0;
            min-width: 200px;
        }
        .move-menu.show {
            display: block;
        }
        .move-menu-item {
            padding: 10px 15px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .move-menu-item:hover {
            background-color: #f5f5f5;
        }

        /* ESTILOS DOS MODAIS */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: #fff; padding: 20px 30px 30px 30px; border-radius: 10px; width: 90%; max-width: 800px; max-height: 90vh; overflow-y: auto; position: relative; }
        
        .modal-header-container {
            display: flex;
            flex-direction: column; /* Alterado para coluna */
            align-items: flex-start; /* Alinha itens à esquerda */
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        .modal-header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        .modal-header-container h1 {
            font-size: 1.5rem;
            margin: 0;
            flex-grow: 1;
        }
        /* NOVO ESTILO PARA TIPO DE MANUTENÇÃO NO MODAL */
        .maintenance-type-modal {
            font-size: 1rem;
            font-weight: 500;
            color: #555;
            margin-top: 5px;
            background-color: #f0f0f0;
            padding: 4px 10px;
            border-radius: 5px;
        }
        .modal-close { 
            font-size: 2.5rem; 
            font-weight: 300; 
            cursor: pointer; 
            border: none; 
            background: none; 
            padding: 0 10px;
            line-height: 1;
        }

        .modal-body .form-section { border: 1px solid #e0e0e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .modal-body h2 { font-size: 1.2rem; color: #3498db; margin-top: 0; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 10px; }
        .modal-body p, .modal-body .details-grid p { font-size: 1rem; margin: 5px 0; white-space: pre-wrap; }
        .modal-body .details-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0 20px; }
        .modal-body .form-group { margin-bottom: 15px; }
        .modal-body .form-group label { display: block; font-weight: 500; margin-bottom: 5px; }
        .modal-body .form-group input, .modal-body .form-group select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 1rem; box-sizing: border-box; font-family: 'Inter', sans-serif; }
        
        .modal-body .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 1rem;
            box-sizing: border-box;
            font-family: 'Inter', sans-serif;
            resize: none;
            overflow-y: hidden;
            min-height: 80px;
        }

        .modal-footer { display: flex; flex-wrap: wrap; justify-content: flex-end; gap: 10px; margin-top: 20px; }
        .btn-action { text-decoration: none; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 500; transition: background-color 0.2s ease; }
        .btn-edit { background-color: #f39c12; }
        .btn-pdf { background-color: #3498db; }
        .btn-pdf:disabled { background-color: #bdc3c7; }
        .btn-save { background-color: #2ecc71; }
        .btn-finalize { background-color: #27ae60; } /* Verde mais escuro */
        .btn-archive { background-color: #7f8c8d; } /* Cinza */
        
        .signature-modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .signature-modal-content { background-color: #fff; padding: 20px; border-radius: 10px; width: 95%; max-width: 600px; text-align: center; display: flex; flex-direction: column; }
        .signature-modal-content canvas { border: 2px dashed #ccc; border-radius: 6px; cursor: crosshair; width: 100%; height: 250px; }
        .signature-modal-buttons { margin-top: 15px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .signature-modal-buttons button { padding: 10px 20px; border-radius: 5px; border: none; cursor: pointer; font-size: 1rem; }
        #signature-save-button-details { background-color: #2ecc71; color: white; }
        #signature-undo-button-details { background-color: #f39c12; color: white; }
        #signature-clear-button-details { background-color: #e74c3c; color: white; }
        #signature-cancel-button-details { background-color: #95a5a6; color: white; }
        #signature-error-message-details { color: #e74c3c; font-weight: 500; margin-top: 10px; display: none; }
        .signature-placeholder { border: 2px dashed #ccc; border-radius: 6px; padding: 20px; text-align: center; cursor: pointer; color: #7f8c8d; }
        .signature-thumbnail { max-width: 200px; max-height: 100px; border: 1px solid #ccc; border-radius: 6px; cursor: pointer; }

        .signature-modal-overlay:fullscreen { background-color: #fff; }
        .signature-modal-overlay:fullscreen .signature-modal-content { height: 100%; width: 100%; max-width: none; border-radius: 0; padding: 15px; box-sizing: border-box; }
        .signature-modal-overlay:fullscreen .signature-modal-content canvas { flex-grow: 1; height: auto; }

        /* Estilos da Notificação Toast */
        #toast-notification {
            visibility: hidden;
            min-width: 250px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 8px;
            padding: 16px;
            position: fixed;
            z-index: 2000;
            left: 50%;
            transform: translateX(-50%);
            bottom: 30px;
            font-size: 1rem;
            opacity: 0;
            transition: opacity 0.5s, bottom 0.5s;
        }

        #toast-notification.show {
            visibility: visible;
            opacity: 1;
            bottom: 50px;
        }
        
        /* Estilos dos novos modais de confirmação */
        .confirmation-modal-content {
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            text-align: center;
            width: 90%;
            max-width: 400px;
        }
        .confirmation-modal-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.2rem;
        }
        .confirmation-modal-content p {
            margin-bottom: 25px;
        }
        .confirmation-modal-content .form-group {
            margin-bottom: 20px;
            text-align: left;
        }
        .confirmation-modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        /* ESTILOS RESPONSIVOS PARA CELULAR */
        @media (max-width: 768px) {
            .board-header {
                flex-wrap: wrap;
                padding: 10px 15px;
            }
            .header-top {
                display: flex;
                justify-content: space-between;
                align-items: center;
                width: 100%;
                margin-bottom: 15px;
            }
            .header-top img {
                height: auto;
                max-width: 180px; 
            }
            .header-bottom {
                width: 100%;
                text-align: center;
            }
            .board-header h1 {
                font-size: 1.25rem;
                margin-bottom: 10px;
            }
            .header-legend {
                justify-content: center;
                margin-left: 0;
            }
            .board { scroll-snap-type: none; }
            .list { scroll-snap-align: none; }
        }
    </style>
</head>
<body>
    <div class="board-container">
        <header class="board-header">
            <div class="header-top">
                <a href="index.html"><img src="./images/logo.png" alt="Logo BM Medical"></a>
                <button id="logout-button" class="logout-button">Sair</button>
            </div>
            <div class="header-bottom">
                <h1>Quadro de Ordens de Serviço</h1>
                <div class="header-legend">
                    <div class="legend-item">
                        <span class="legend-color-dot" style="background-color: #2980b9;"></span>
                        UFPEL
                    </div>
                    <div class="legend-item">
                        <span class="legend-color-dot" style="background-color: #f39c12;"></span>
                        Capão do Leão
                    </div>
                    <div class="legend-item">
                        <span class="legend-color-dot" style="background: repeating-linear-gradient(to bottom, #2F4F2F, #2F4F2F 25%, #8B4513 25%, #8B4513 50%, #6B8E23 50%, #6B8E23 75%, #556B2F 75%, #556B2F 100%);"></span>
                        Exército
                    </div>
                </div>
            </div>
        </header>

        <main class="board" id="board">
            <!-- As colunas são preenchidas dinamicamente pelo JavaScript -->
        </main>
    </div>

    <!-- Menu de movimentação global -->
    <div id="global-move-menu" class="move-menu"></div>

    <!-- Modais -->
    <div id="details-modal" class="modal-overlay">
        <div class="modal-content">
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>
    <div id="signature-modal-details" class="signature-modal-overlay">
        <div class="signature-modal-content">
            <h3>Assine no campo abaixo:</h3>
            <canvas id="signature-pad-details"></canvas>
            <p id="signature-error-message-details">Por favor, desenhe uma assinatura para salvar.</p>
            <div class="signature-modal-buttons">
                <button type="button" id="signature-undo-button-details">Desfazer</button>
                <button type="button" id="signature-clear-button-details">Limpar</button>
                <button type="button" id="signature-save-button-details">Salvar</button>
                <button type="button" id="signature-cancel-button-details">Cancelar</button>
            </div>
        </div>
    </div>
    
    <!-- Modal de Confirmação para Finalizar -->
    <div id="finalize-modal" class="modal-overlay" style="z-index: 1001;">
        <div class="confirmation-modal-content">
            <h3>Finalizar Ordem de Serviço</h3>
            <div class="form-group">
                <label for="completion-date">Data de Conclusão</label>
                <input type="date" id="completion-date" class="form-group-input">
            </div>
            <div class="confirmation-modal-buttons">
                <button type="button" id="cancel-finalize-btn" class="btn-action btn-archive">Cancelar</button>
                <button type="button" id="confirm-finalize-btn" class="btn-action btn-finalize">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmação para Arquivar -->
    <div id="archive-modal" class="modal-overlay" style="z-index: 1001;">
        <div class="confirmation-modal-content">
            <h3>Arquivar Ordem de Serviço</h3>
            <p>Deseja realmente arquivar (cancelar) esta OS? Esta ação não pode ser desfeita do quadro.</p>
            <div class="confirmation-modal-buttons">
                <button type="button" id="cancel-archive-btn" class="btn-action btn-archive">Cancelar</button>
                <button type="button" id="confirm-archive-btn" class="btn-action btn-edit">Sim, Arquivar</button>
            </div>
        </div>
    </div>


    <!-- Elemento da Notificação Toast -->
    <div id="toast-notification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, updateDoc, onSnapshot, query, where, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const board = document.getElementById('board');
        const modalOverlay = document.getElementById('details-modal');
        const modalBody = document.getElementById('modal-body');
        const globalMoveMenu = document.getElementById('global-move-menu');
        
        const finalizeModal = document.getElementById('finalize-modal');
        const archiveModal = document.getElementById('archive-modal');
        let currentOrderForAction = null;

        const statuses = {
            'novas': 'Novas OS',
            'em_execucao': 'Em Execução',
            'aguardando_pecas': 'Aguardando Peças',
            'pronto_entrega': 'Pronto para Entrega'
        };

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function showToast(message) {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        function initializeBoard() {
            for (const statusKey in statuses) {
                const list = document.createElement('div');
                list.className = 'list';
                list.dataset.status = statusKey;
                list.innerHTML = `
                    <div class="list-header">${statuses[statusKey]}</div>
                    <div class="cards"></div>
                `;
                board.appendChild(list);
            }
        }

        function listenToOrders() {
            const q = query(collection(db, "orders"));
            
            onSnapshot(q, (snapshot) => {
                const ordersByStatus = {};
                for (const key in statuses) {
                    ordersByStatus[key] = [];
                }

                snapshot.forEach(doc => {
                    const order = { id: doc.id, ...doc.data() };
                    if (typeof order.position === 'undefined') {
                        order.position = order.createdAt?.toMillis() || Date.now();
                    }
                    if (order.status && statuses.hasOwnProperty(order.status)) {
                        ordersByStatus[order.status].push(order);
                    }
                });

                for (const status in ordersByStatus) {
                    const listContainer = document.querySelector(`.list[data-status="${status}"] .cards`);
                    if (!listContainer) continue;

                    const scrollTop = listContainer.scrollTop;
                    listContainer.innerHTML = '';
                    
                    ordersByStatus[status]
                        .sort((a, b) => a.position - b.position)
                        .forEach(order => listContainer.appendChild(createCard(order)));
                    
                    listContainer.scrollTop = scrollTop;
                }
            });
        }

        function createCard(order) {
            const card = document.createElement('div');
            card.className = 'card';
            card.dataset.id = order.id;
            card.dataset.status = order.status;

            const contractColors = {
                'Contrato N° 03/2024': '#2980b9',     // UFPEL -> Azul Royal
                'Contrato Nº 138/2024': '#f39c12',    // Capão do Leão -> Laranja Energia
                'Contrato Nº 10/2025': 'gradient',   // Exército -> Gradiente
            };
            
            const color = contractColors[order.contrato];

            if (color === 'gradient') {
                card.style.borderImage = 'repeating-linear-gradient(to bottom, #2F4F2F, #2F4F2F 25%, #8B4513 25%, #8B4513 50%, #6B8E23 50%, #6B8E23 75%, #556B2F 75%, #556B2F 100%) 1';
            } else {
                card.style.borderLeftColor = color || '#3498db'; // Fallback
            }


            const isSigned = order.signature_data && typeof order.signature_data === 'string' && order.signature_data.length > 200;
            const signedIcon = `<div class="icon-signed" title="OS Assinada"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52"><circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/><path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/></svg></div>`;
            const unsignedIcon = `<div class="icon-unsigned" title="Assinatura pendente"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#6c757d" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20h9"></path><path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path></svg><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#e74c3c" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg></div>`;
            
            const formattedDate = formatDate(order.data_servico || order.data_retirada);

            let maintenanceTypeHtml = '';
            if (order.tipo_manutencao === 'preventiva') {
                maintenanceTypeHtml = '<p class="maintenance-type-card">MP</p>';
            } else if (order.tipo_manutencao === 'corretiva') {
                maintenanceTypeHtml = '<p class="maintenance-type-card">MC</p>';
            }

            card.innerHTML = `
                <div class="card-status-icon">${isSigned ? signedIcon : unsignedIcon}</div>
                <strong>${order.os_numero || 'N/A'}</strong>
                <p>${order.equipamento || 'N/A'}</p>
                <p>Data: ${formattedDate}</p>
                ${maintenanceTypeHtml}
                <div class="card-move-action">
                    <div class="card-move-icon" title="Mover cartão">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor"><path d="M13 6V3L18.5 8.5L13 14V11H4V6H13M20 16V18H4V21H20V16Z"/></svg>
                    </div>
                </div>
            `;

            card.addEventListener('click', (e) => {
                if (!e.target.closest('.card-move-action')) {
                    openDetailsModal(order.id);
                }
            });

            const moveIcon = card.querySelector('.card-move-icon');
            moveIcon.addEventListener('click', (e) => {
                e.stopPropagation();
                showMoveMenu(card, moveIcon);
            });

            return card;
        }
        
        function showMoveMenu(card, icon) {
            const orderId = card.dataset.id;
            const currentStatus = card.dataset.status;
            
            globalMoveMenu.innerHTML = '';

            for (const statusKey in statuses) {
                if (statusKey !== currentStatus) {
                    const item = document.createElement('div');
                    item.className = 'move-menu-item';
                    item.textContent = statuses[statusKey];
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        moveCardToStatus(orderId, statusKey);
                        globalMoveMenu.classList.remove('show');
                    });
                    globalMoveMenu.appendChild(item);
                }
            }
            
            globalMoveMenu.style.visibility = 'hidden';
            globalMoveMenu.style.left = '-1000px'; 
            globalMoveMenu.classList.add('show'); 

            const menuWidth = globalMoveMenu.offsetWidth;
            const menuHeight = globalMoveMenu.offsetHeight;

            globalMoveMenu.classList.remove('show');
            globalMoveMenu.style.visibility = 'visible';
            globalMoveMenu.style.left = '0px';

            const iconRect = icon.getBoundingClientRect();
            const windowWidth = window.innerWidth;
            const windowHeight = window.innerHeight;
            const margin = 8; 

            let topPos = iconRect.bottom + margin;
            let leftPos = iconRect.left;
            
            if (topPos + menuHeight > windowHeight) {
                topPos = iconRect.top - menuHeight - margin;
            }
            if (topPos < 0) {
                topPos = margin;
            }
            if (leftPos + menuWidth > windowWidth) {
                leftPos = windowWidth - menuWidth - margin;
            }
            if (leftPos < 0) {
                leftPos = margin;
            }

            globalMoveMenu.style.top = `${topPos}px`;
            globalMoveMenu.style.left = `${leftPos}px`;
            globalMoveMenu.classList.add('show');
        }

        async function moveCardToStatus(orderId, newStatus) {
            const orderRef = doc(db, "orders", orderId);
            try {
                await updateDoc(orderRef, { 
                    status: newStatus, 
                    position: Date.now() 
                });
            } catch (error) {
                console.error("Erro ao atualizar a OS:", error);
                showToast("Erro ao mover o cartão.");
            }
        }

        async function openDetailsModal(orderId) {
            try {
                const docRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error('OS não encontrada');
                const order = { id: docSnap.id, ...docSnap.data() };
                currentOrderForAction = order;
                modalBody.innerHTML = generateDetailsView(order);
                addModalEventListeners(order);
                modalOverlay.style.display = 'flex';
            } catch (error) {
                console.error("Erro ao abrir detalhes:", error);
                showToast(`Erro ao buscar detalhes: ${error.message}`);
            }
        }

        function generateDetailsView(order) {
            const isSigned = order.signature_data && order.signature_data.length > 200;
            let signatureSectionHtml = isSigned
                ? `<img src="${order.signature_data}" class="signature-thumbnail" alt="Assinatura">`
                : `<div class="signature-placeholder">Sem Assinatura</div>`;
            
            let servicosDisplayHtml;
            if (order.servicos_realizados === "Recebimento de equipamento para análise.") {
                servicosDisplayHtml = `<p><strong>Serviços Realizados:</strong></p><p style="font-style: italic; color: #7f8c8d;">Equipamento recebido para análise.</p>`;
            } else {
                servicosDisplayHtml = `<p><strong>Serviços Realizados:</strong><br>${(order.servicos_realizados || 'Não informado.').replace(/\n/g, '<br>')}</p>`;
            }

            const formattedRetirada = formatDate(order.data_servico || order.data_retirada);
            const formattedDevolucao = formatDate(order.data_devolucao);

            let maintenanceTypeFullText = '';
            if (order.tipo_manutencao === 'preventiva') {
                maintenanceTypeFullText = 'MP - Manutenção Preventiva';
            } else if (order.tipo_manutencao === 'corretiva') {
                maintenanceTypeFullText = 'MC - Manutenção Corretiva';
            }
            
            let attendanceHtml = '';
            const ufpelContract = 'Contrato N° 03/2024';
            const capaoContract = 'Contrato Nº 138/2024';
            const exercitoContract = 'Contrato Nº 10/2025';

            if (order.contrato === ufpelContract) {
                attendanceHtml = `
                    <p><strong>Data do Serviço:</strong> ${formattedRetirada}</p>
                    <p><strong>Hora de Chegada:</strong> ${order.hora_chegada || 'N/A'}</p>
                    <p><strong>Hora de Saída:</strong> ${order.hora_saida || 'N/A'}</p>
                    <p><strong>Local do Atendimento:</strong> CME / HE-UFPEL</p>
                `;
            } else if (order.contrato === capaoContract || order.contrato === exercitoContract) {
                 attendanceHtml = `
                    <p><strong>Data da Retirada / Serviço:</strong> ${formattedRetirada}</p>
                    <p><strong>Data da Devolução:</strong> ${formattedDevolucao}</p>
                    <p><strong>Local do Atendimento:</strong> ${order.local_atendimento || 'N/A'}</p>
                `;
            } else {
                // Fallback for any other contract
                attendanceHtml = `
                    <p><strong>Data da Retirada / Serviço:</strong> ${formattedRetirada}</p>
                    <p><strong>Data da Devolução:</strong> ${formattedDevolucao}</p>
                `;
            }

            return `
                <div class="modal-header-container">
                    <div class="modal-header-top">
                        <h1>Detalhes da OS: ${order.os_numero}</h1>
                        <button class="modal-close">&times;</button>
                    </div>
                    ${maintenanceTypeFullText ? `<p class="maintenance-type-modal">${maintenanceTypeFullText}</p>` : ''}
                </div>
                <div class="form-section"><h2>Dados do Cliente</h2><p><strong>Contrato:</strong> ${order.contrato||'N/A'}</p><p><strong>Cliente:</strong> ${order.cliente||'N/A'}</p><p><strong>Endereço:</strong> ${order.endereco||'N/A'}</p></div>
                <div class="form-section"><h2>Dados do Equipamento</h2><p><strong>Equipamento:</strong> ${order.equipamento||'N/A'}</p><p><strong>Marca:</strong> ${order.marca||'N/A'}</p><p><strong>Modelo:</strong> ${order.modelo||'N/A'}</p><p><strong>Serial:</strong> ${order.serial||'N/A'}</p></div>
                <div class="form-section">
                    <h2>Atendimento</h2>
                    ${attendanceHtml}
                </div>
                <div class="form-section">
                    <h2>Serviços e Peças</h2>
                    ${servicosDisplayHtml}
                    <p><strong>Peças Utilizadas:</strong><br>${order.pecas_utilizadas||'Nenhuma'}</p>
                </div>
                <div class="form-section"><h2>Assinaturas</h2><div class="signature-grid"><div class="signature-box"><label>Responsável do Setor:</label><div id="signature-container-details">${signatureSectionHtml}</div></div><div class="signature-box"><label>Responsável Técnico:</label><img src="./images/assinatura-tecnico.png" style="max-width:200px;"></div></div></div>
                <div class="modal-footer">
                    <button id="modal-btn-archive" class="btn-action btn-archive">Arquivar OS</button>
                    <button id="modal-btn-edit" class="btn-action btn-edit">Editar OS</button>
                    <button id="modal-btn-pdf" class="btn-action btn-pdf">Gerar PDF</button>
                    <button id="modal-btn-finalize" class="btn-action btn-finalize">Finalizar OS</button>
                </div>`;
        }

        function addModalEventListeners(order) {
            document.getElementById('modal-btn-archive').addEventListener('click', handleArchiveClick);
            document.getElementById('modal-btn-edit').addEventListener('click', () => switchToEditMode(order.id));
            document.getElementById('modal-btn-pdf').addEventListener('click', (e) => generatePdfForOrder(order.id, e.target));
            document.getElementById('modal-btn-finalize').addEventListener('click', handleFinalizeClick);
        }
        
        function autoGrowTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
            if (element.scrollHeight > 250) {
                element.style.overflowY = 'auto';
                element.style.height = '250px';
            } else {
                element.style.overflowY = 'hidden';
            }
        }

        async function switchToEditMode(orderId) {
            const docRef = doc(db, "orders", orderId);
            const docSnap = await getDoc(docRef);
            if(docSnap.exists()){
                const order = { id: docSnap.id, ...docSnap.data() };
                modalBody.innerHTML = generateEditForm(order);
                const editForm = document.getElementById('edit-os-form');
                editForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    saveOrderChanges(orderId);
                });
                
                const textareas = editForm.querySelectorAll('textarea');
                textareas.forEach(textarea => {
                    textarea.addEventListener('input', () => autoGrowTextarea(textarea));
                    autoGrowTextarea(textarea);
                });

                const equipamentoSelect = editForm.querySelector('#edit_equipamento_select');
                if (equipamentoSelect) {
                    equipamentoSelect.addEventListener('change', () => {
                        const outroGroup = editForm.querySelector('#edit_outro_equipamento_group');
                        outroGroup.style.display = equipamentoSelect.value === 'Outro' ? 'block' : 'none';
                    });
                    if (equipamentoSelect.value === 'Outro') {
                        equipamentoSelect.dispatchEvent(new Event('change'));
                    }
                }
            }
        }

        function generateEditForm(order) {
            const isSigned = order.signature_data && order.signature_data.length > 200;
            let signatureSectionHtml = isSigned 
                ? `<img src="${order.signature_data}" class="signature-thumbnail" alt="Assinatura" onclick="openSignatureModalDetails()">` 
                : `<div id="signature-placeholder-details" class="signature-placeholder" onclick="openSignatureModalDetails()">Adicionar Assinatura</div>`;
            
            let equipmentFields = '';
            let attendanceFields = '';
            const ufpelContract = 'Contrato N° 03/2024';
            const capaoContract = 'Contrato Nº 138/2024';
            const exercitoContract = 'Contrato Nº 10/2025';

            if (order.contrato === ufpelContract) {
                 attendanceFields = `<div class="form-group"><label for="edit_data_servico">Data do Serviço:</label><input type="date" id="edit_data_servico" name="data_servico" value="${order.data_servico||''}"></div><div class="form-group"><label for="edit_hora_chegada">Hora de Chegada:</label><input type="time" id="edit_hora_chegada" name="hora_chegada" value="${order.hora_chegada||''}"></div><div class="form-group"><label for="edit_hora_saida">Hora de Saída:</label><input type="time" id="edit_hora_saida" name="hora_saida" value="${order.hora_saida||''}"></div>`;
            } else {
                const isCapao = order.contrato === capaoContract;
                const isExercito = order.contrato === exercitoContract;
                const equipmentOptionsList = isCapao 
                    ? ['Micromotor Odontológico','Caneta de Alta Rotação','Autoclave de Bancada','Contra-Ângulo','Ultrassom Tipo Borden','Ultrassom Com Jato De Bicarbonato','Esfigmomanômetro','Compressor Odontológico','Cadeira Odontológica','Balança Antropométrica','Balança Neonatal'] 
                    : ['Micromotor Odontológico','Caneta de Alta Rotação','Autoclave de Bancada','Contra-Ângulo','Ultrassom Com Jato De Bicarbonato','Compressor Odontológico','Cadeira Odontológica','Raio-X Odontológico','Mocho Odontológico'];
                const isCustomEquipment = !equipmentOptionsList.includes(order.equipamento);
                const optionsHtml = equipmentOptionsList.map(opt => `<option value="${opt}" ${order.equipamento===opt?'selected':''}>${opt}</option>`).join('');
                equipmentFields = `<div class="form-group"><label for="edit_equipamento_select">Equipamento:</label><select id="edit_equipamento_select" name="equipamento_select">${optionsHtml}<option value="Outro" ${isCustomEquipment?'selected':''}>Outro</option></select></div><div class="form-group" id="edit_outro_equipamento_group" style="display:${isCustomEquipment?'block':'none'};"><label for="edit_outro_equipamento">Qual equipamento?</label><input type="text" id="edit_outro_equipamento" name="outro_equipamento" value="${isCustomEquipment?order.equipamento:''}"></div><div class="form-group"><label for="edit_marca">Marca:</label><input type="text" id="edit_marca" name="marca" value="${order.marca||''}"></div><div class="form-group"><label for="edit_modelo">Modelo:</label><input type="text" id="edit_modelo" name="modelo" value="${order.modelo||''}"></div><div class="form-group"><label for="edit_serial">Serial:</label><input type="text" id="edit_serial" name="serial" value="${order.serial||''}"></div>`;
                attendanceFields = `<div class="form-group"><label for="edit_data_retirada">Data da Retirada:</label><input type="date" id="edit_data_retirada" name="data_retirada" value="${order.data_retirada||''}"></div><div class="form-group"><label for="edit_data_devolucao">Data da Devolução:</label><input type="date" id="edit_data_devolucao" name="data_devolucao" value="${order.data_devolucao||''}"></div>`;
                
                if (isCapao || isExercito) {
                    const locationOptions = isCapao 
                        ? ['Pronto Atendimento Municipal','UBS Central','UBS Casabom','UBS I - Parque Fragata','UBS II - Jardim América','UBS III - Jardim América','UBS Campus UFPEL','CAPS - Casa Vida']
                        : ['GO 1', 'GO 2', 'GO 3', 'GO 4', 'PMGuPel'];
                    const locationHtml = locationOptions.map(opt => `<option value="${opt}" ${order.local_atendimento===opt?'selected':''}>${opt}</option>`).join('');
                    attendanceFields += `<div class="form-group"><label for="edit_local_atendimento">Local:</label><select id="edit_local_atendimento" name="local_atendimento">${locationHtml}</select></div>`;
                }
            }
            return `
                <div class="modal-header-container">
                    <h1>Editar OS: ${order.os_numero}</h1>
                    <button class="modal-close">&times;</button>
                </div>
                <form id="edit-os-form">
                    <input type="hidden" id="edit_signature_data" value="${order.signature_data || ''}">
                    ${equipmentFields?`<div class="form-section"><h2>Dados do Equipamento</h2>${equipmentFields}</div>`:''}
                    <div class="form-section"><h2>Atendimento</h2>${attendanceFields}</div>
                    <div class="form-section"><h2>Serviços e Peças</h2><div class="form-group"><label for="edit_servicos_realizados">Serviços Realizados:</label><textarea id="edit_servicos_realizados">${order.servicos_realizados||''}</textarea></div><div class="form-group"><label for="edit_pecas_utilizadas">Peças Utilizadas:</label><textarea id="edit_pecas_utilizadas">${order.pecas_utilizadas||''}</textarea></div></div>
                    <div class="form-section"><h2>Assinaturas</h2><div class="signature-grid"><div class="signature-box"><label>Responsável do Setor:</label><div id="signature-container-details">${signatureSectionHtml}</div></div><div class="signature-box"><label>Responsável Técnico:</label><img src="./images/assinatura-tecnico.png" style="max-width:200px;"></div></div></div>
                    <div class="modal-footer"><button type="submit" class="btn-action btn-save">Salvar Alterações</button></div>
                </form>`;
        }
        
        async function saveOrderChanges(orderId) {
            const form = document.getElementById('edit-os-form');
            const updatedData = {};
            
            if(form.equipamento_select){updatedData.equipamento=form.equipamento_select.value==='Outro'?form.outro_equipamento.value:form.equipamento_select.value}
            if(form.marca)updatedData.marca=form.marca.value;if(form.modelo)updatedData.modelo=form.modelo.value;if(form.serial)updatedData.serial=form.serial.value;if(form.data_servico)updatedData.data_servico=form.data_servico.value;if(form.hora_chegada)updatedData.hora_chegada=form.hora_chegada.value;if(form.hora_saida)updatedData.hora_saida=form.hora_saida.value;if(form.data_retirada)updatedData.data_retirada=form.data_retirada.value;if(form.data_devolucao)updatedData.data_devolucao=form.data_devolucao.value;if(form.local_atendimento)updatedData.local_atendimento=form.local_atendimento.value;
            updatedData.servicos_realizados = document.getElementById('edit_servicos_realizados').value;
            updatedData.pecas_utilizadas = document.getElementById('edit_pecas_utilizadas').value;
            
            const signatureInput = document.getElementById('edit_signature_data');
            if (signatureInput) {
                updatedData.signature_data = signatureInput.value;
            }

            const orderRef = doc(db, "orders", orderId);
            try {
                await updateDoc(orderRef, updatedData);
                showToast('OS atualizada com sucesso!');
                modalOverlay.style.display = 'none';
            } catch (error) {
                console.error("Erro ao salvar alterações:", error);
                showToast("Erro ao salvar. Tente novamente.");
            }
        }

        // --- Lógica para Finalizar e Arquivar ---

        function handleFinalizeClick() {
            const isSigned = currentOrderForAction.signature_data && currentOrderForAction.signature_data.length > 200;
            if (!isSigned) {
                showToast("Não é possível finalizar: a OS não está assinada.");
                return;
            }
            const dateInput = document.getElementById('completion-date');
            dateInput.value = new Date().toISOString().split('T')[0];
            finalizeModal.style.display = 'flex';
        };

        function handleArchiveClick() {
            archiveModal.style.display = 'flex';
        };

        document.getElementById('cancel-finalize-btn').addEventListener('click', () => finalizeModal.style.display = 'none');
        document.getElementById('cancel-archive-btn').addEventListener('click', () => archiveModal.style.display = 'none');

        document.getElementById('confirm-finalize-btn').addEventListener('click', async () => {
            const completionDate = document.getElementById('completion-date').value;
            if (!completionDate) {
                showToast("Por favor, selecione uma data de conclusão.");
                return;
            }
            const orderRef = doc(db, "orders", currentOrderForAction.id);
            try {
                await updateDoc(orderRef, {
                    status: 'finalizada',
                    data_conclusao: completionDate
                });
                showToast("OS finalizada com sucesso!");
                finalizeModal.style.display = 'none';
                modalOverlay.style.display = 'none';
            } catch (error) {
                showToast("Erro ao finalizar a OS.");
                console.error("Erro ao finalizar:", error);
            }
        });

        document.getElementById('confirm-archive-btn').addEventListener('click', async () => {
            const orderRef = doc(db, "orders", currentOrderForAction.id);
            try {
                await updateDoc(orderRef, {
                    status: 'arquivada'
                });
                showToast("OS arquivada com sucesso!");
                archiveModal.style.display = 'none';
                modalOverlay.style.display = 'none';
            } catch (error) {
                showToast("Erro ao arquivar a OS.");
                console.error("Erro ao arquivar:", error);
            }
        });


        // --- Lógica da Assinatura ---
        const signatureModalDetails = document.getElementById('signature-modal-details');
        const signaturePadDetails = document.getElementById('signature-pad-details');
        const signatureErrorMessageDetails = document.getElementById('signature-error-message-details');
        const ctxDetails = signaturePadDetails.getContext('2d');
        let drawingDetails = false;
        let isSignatureDrawnDetails = false;
        let signatureHistoryDetails = [];

        function resizeCanvasDetails() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            signaturePadDetails.width = signaturePadDetails.offsetWidth * ratio;
            signaturePadDetails.height = signaturePadDetails.offsetHeight * ratio;
            signaturePadDetails.getContext("2d").scale(ratio, ratio);
            redrawSignatureFromHistoryDetails();
        }
        window.addEventListener("resize", resizeCanvasDetails);

        function getPosDetails(canvas, event) {
            const rect = canvas.getBoundingClientRect();
            const touch = event.touches ? event.touches[0] : event;
            return { x: (touch.clientX - rect.left), y: (touch.clientY - rect.top) };
        }

        function startDrawingDetails(e) {
            drawingDetails = true;
            signatureErrorMessageDetails.style.display = 'none';
            const pos = getPosDetails(signaturePadDetails, e);
            ctxDetails.beginPath();
            ctxDetails.moveTo(pos.x, pos.y);
            e.preventDefault();
        }

        function stopDrawingDetails(e) {
            if (!drawingDetails) return;
            drawingDetails = false;
            ctxDetails.beginPath();
            saveSignatureStateDetails();
            e.preventDefault();
        }

        function drawDetails(e) {
            if (!drawingDetails) return;
            isSignatureDrawnDetails = true;
            const pos = getPosDetails(signaturePadDetails, e);
            ctxDetails.lineWidth = 3;
            ctxDetails.lineCap = 'round';
            ctxDetails.strokeStyle = '#000';
            ctxDetails.lineTo(pos.x, pos.y);
            ctxDetails.stroke();
            ctxDetails.beginPath();
            ctxDetails.moveTo(pos.x, pos.y);
            e.preventDefault();
        }

        async function openSignaturePadInLandscapeDetails() {
            const isMobile = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0);
            isSignatureDrawnDetails = false;
            signatureErrorMessageDetails.style.display = 'none';
            signatureHistoryDetails = [];
            try {
                if (isMobile && typeof screen.orientation.lock === 'function') {
                    await signatureModalDetails.requestFullscreen();
                    await screen.orientation.lock('landscape-primary');
                }
            } catch (err) {
                console.warn("Não foi possível ativar o modo paisagem/tela cheia.", err);
            } finally {
                signatureModalDetails.style.display = 'flex';
                resizeCanvasDetails();
                saveSignatureStateDetails();
            }
        }

        async function closeSignaturePadDetails() {
            signatureModalDetails.style.display = 'none';
            try {
                if (document.fullscreenElement) {
                    await screen.orientation.unlock();
                    await document.exitFullscreen();
                }
            } catch (err) {
                console.error("Erro ao tentar sair do modo tela cheia/paisagem.", err);
            }
        }

        function saveSignatureStateDetails() {
            const data = ctxDetails.getImageData(0, 0, signaturePadDetails.width, signaturePadDetails.height);
            signatureHistoryDetails.push(data);
        }

        function undoLastStrokeDetails() {
            if (signatureHistoryDetails.length > 1) {
                signatureHistoryDetails.pop();
                redrawSignatureFromHistoryDetails();
            }
        }

        function redrawSignatureFromHistoryDetails() {
            ctxDetails.clearRect(0, 0, signaturePadDetails.width, signaturePadDetails.height);
            if (signatureHistoryDetails.length > 0) {
                ctxDetails.putImageData(signatureHistoryDetails[signatureHistoryDetails.length - 1], 0, 0);
            }
            isSignatureDrawnDetails = signatureHistoryDetails.length > 1;
        }

        window.openSignatureModalDetails = () => {
            openSignaturePadInLandscapeDetails();
        };
        
        signaturePadDetails.addEventListener('mousedown', startDrawingDetails);
        signaturePadDetails.addEventListener('mouseup', stopDrawingDetails);
        signaturePadDetails.addEventListener('mousemove', drawDetails);
        signaturePadDetails.addEventListener('touchstart', startDrawingDetails, { passive: false });
        signaturePadDetails.addEventListener('touchend', stopDrawingDetails, { passive: false });
        signaturePadDetails.addEventListener('touchmove', drawDetails, { passive: false });

        document.getElementById('signature-cancel-button-details').addEventListener('click', closeSignaturePadDetails);
        document.getElementById('signature-undo-button-details').addEventListener('click', undoLastStrokeDetails);

        document.getElementById('signature-clear-button-details').addEventListener('click', () => {
            ctxDetails.clearRect(0, 0, signaturePadDetails.width, signaturePadDetails.height);
            isSignatureDrawnDetails = false;
            signatureHistoryDetails = [signatureHistoryDetails[0]];
        });

        document.getElementById('signature-save-button-details').addEventListener('click', () => {
            if (!isSignatureDrawnDetails) {
                signatureErrorMessageDetails.style.display = 'block';
                return;
            }
            const data = ctxDetails.getImageData(0, 0, signaturePadDetails.width, signaturePadDetails.height);
            const compositeOperation = ctxDetails.globalCompositeOperation;
            ctxDetails.globalCompositeOperation = "destination-over";
            ctxDetails.fillStyle = '#FFFFFF';
            ctxDetails.fillRect(0,0,signaturePadDetails.width,signaturePadDetails.height);
            const signatureData = signaturePadDetails.toDataURL('image/jpeg', 0.5);
            ctxDetails.clearRect(0,0,signaturePadDetails.width,signaturePadDetails.height);
            ctxDetails.putImageData(data, 0,0);
            ctxDetails.globalCompositeOperation = compositeOperation;
            
            const signatureInput = document.getElementById('edit_signature_data');
            if (signatureInput) {
                signatureInput.value = signatureData;
            }
            const signatureContainer = document.getElementById('signature-container-details');
            if(signatureContainer) {
                signatureContainer.innerHTML = `<img src="${signatureData}" class="signature-thumbnail" alt="Assinatura" onclick="openSignatureModalDetails()">`;
            }
            closeSignaturePadDetails();
        });
        
        async function generatePdfForOrder(orderId, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'Gerando...';
            try {
                const logoDataUrl = await imageToDataUrl('./images/logo.png', 0.9);
                const techSigDataUrl = await imageToDataUrl('./images/assinatura-tecnico.png', 0.7);
                const docRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) throw new Error('OS não encontrada.');
                const order = docSnap.data();
                const { jsPDF } = window.jspdf;
                const docPDF = new jsPDF();
                const pageHeight = docPDF.internal.pageSize.height;
                const pageWidth = docPDF.internal.pageSize.width;
                const margin = 15;
                let yPosition = 10;

                // --- Cabeçalho ---
                docPDF.addImage(logoDataUrl, 'JPEG', margin, yPosition, 72, 32);
                docPDF.setFontSize(8).setFont(undefined, 'normal');
                docPDF.text('BM MEDICAL', pageWidth - margin, yPosition + 5, { align: 'right' });
                docPDF.text('Manutenção Hospitalar', pageWidth - margin, yPosition + 9, { align: 'right' });
                docPDF.text('CNPJ: 48.673.158/0001-59', pageWidth - margin, yPosition + 13, { align: 'right' });
                docPDF.text('Av. Duque de Caxias, 915-B403, Pelotas-RS', pageWidth - margin, yPosition + 17, { align: 'right' });
                docPDF.text('Fone: (51) 99377-5933', pageWidth - margin, yPosition + 21, { align: 'right' });
                yPosition += 38;

                // --- Título da OS ---
                docPDF.setFontSize(20).setFont(undefined, 'bold');
                docPDF.text(`OS ${order.os_numero}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 8;

                if (order.tipo_manutencao) {
                    docPDF.setFontSize(12).setFont(undefined, 'normal');
                    const typeText = order.tipo_manutencao === 'preventiva' ? 'MP - Manutenção Preventiva' : 'MC - Manutenção Corretiva';
                    docPDF.text(typeText, pageWidth / 2, yPosition, { align: 'center' });
                }
                yPosition += 12;

                // --- Função para desenhar seções ---
                const drawSection = (title, contentCallback) => {
                    const startY = yPosition;
                    const contentY = startY + 10;
                    
                    const finalY = contentCallback(contentY, true); 
                    const contentHeight = finalY - contentY;
                    const boxHeight = contentHeight + 18; 
                    
                    docPDF.setDrawColor('#e0e0e0').setFillColor('#ffffff');
                    docPDF.roundedRect(margin, startY - 5, pageWidth - (margin * 2), boxHeight, 3, 3, 'FD');
                    
                    docPDF.setFontSize(14).setTextColor('#3498db').setFont(undefined, 'bold');
                    docPDF.text(title, margin + 4, startY);
                    docPDF.setDrawColor('#3498db').setLineWidth(0.5).line(margin + 4, startY + 2, pageWidth - margin - 4, startY + 2);

                    docPDF.setFontSize(12).setTextColor('#000000').setFont(undefined, 'normal');
                    contentCallback(contentY, false);

                    yPosition = startY + boxHeight + 3;
                };

                // --- Seções ---
                drawSection('Dados do Cliente', (currentY, isDryRun) => {
                    let y = currentY;
                    if (!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Contrato:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.contrato || 'N/A', margin + 27, y);
                        y += 6;
                        docPDF.setFont(undefined, 'bold').text('Cliente:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.cliente || 'N/A', margin + 27, y);
                        y += 6;
                        docPDF.setFont(undefined, 'bold').text('Endereço:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.endereco || 'N/A', margin + 27, y);
                    }
                    return y + 18;
                });

                drawSection('Dados do Equipamento', (currentY, isDryRun) => {
                    let y = currentY;
                    const equipLines = docPDF.splitTextToSize(order.equipamento || 'N/A', pageWidth - margin * 2 - 40);
                    if (!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Equipamento:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(equipLines, margin + 34, y);
                    }
                    y += 6 * equipLines.length;

                    if(!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Marca:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.marca || 'N/A', margin + 19, y);
                        docPDF.setFont(undefined, 'bold').text('Modelo:', margin + 70, y);
                        docPDF.setFont(undefined, 'normal').text(order.modelo || 'N/A', margin + 87, y);
                        docPDF.setFont(undefined, 'bold').text('Serial:', margin + 130, y);
                        docPDF.setFont(undefined, 'normal').text(order.serial || 'N/A', margin + 144, y);
                    }
                    return y + 6;
                });
                
                drawSection('Dados do Atendimento', (currentY, isDryRun) => {
                    const ufpelContract = 'Contrato N° 03/2024';
                    const capaoContract = 'Contrato Nº 138/2024';
                    const exercitoContract = 'Contrato Nº 10/2025';
                    let y = currentY;

                    if (order.contrato === ufpelContract) {
                        if (!isDryRun) {
                            docPDF.setFont(undefined, 'bold').text('Data do Serviço:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_servico), margin + 35, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Hora de Chegada:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(order.hora_chegada || 'N/A', margin + 35, y);
                            docPDF.setFont(undefined, 'bold').text('Hora de Saída:', margin + 80, y);
                            docPDF.setFont(undefined, 'normal').text(order.hora_saida || 'N/A', margin + 105, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Local:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text('CME / HE-UFPEL', margin + 20, y);
                        }
                        y += 6;
                    } else if (order.contrato === capaoContract || order.contrato === exercitoContract) {
                        if (!isDryRun) {
                            docPDF.setFont(undefined, 'bold').text('Data da Retirada:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_retirada), margin + 40, y);
                            docPDF.setFont(undefined, 'bold').text('Data da Devolução:', margin + 80, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_devolucao), margin + 120, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Local:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(order.local_atendimento || 'N/A', margin + 19, y);
                        }
                        y += 12;
                    }
                    return y;
                });

                drawSection('Descrição dos Serviços Realizados', (currentY, isDryRun) => {
                    const text = order.servicos_realizados || 'Não informado.';
                    const lines = docPDF.splitTextToSize(text, pageWidth - (margin * 2) - 8);
                    if (!isDryRun) docPDF.text(lines, margin + 4, currentY);
                    return currentY + (lines.length * 6);
                });

                drawSection('Peças Utilizadas', (currentY, isDryRun) => {
                    const text = order.pecas_utilizadas || 'Nenhuma.';
                    const lines = docPDF.splitTextToSize(text, pageWidth - (margin * 2) - 8);
                    if (!isDryRun) docPDF.text(lines, margin + 4, currentY);
                    return currentY + (lines.length * 6);
                });

                // --- Assinaturas (no final da página) ---
                const signatureY = pageHeight - 60;
                const signatureHeight = 25;
                const signatureWidth = 60;
                const roleY = signatureY + signatureHeight + 2;
                const lineY = roleY - 3;
                
                if (order.signature_data && order.signature_data.length > 200) {
                    docPDF.addImage(order.signature_data, 'JPEG', margin + 15, signatureY, signatureWidth, signatureHeight);
                }
                docPDF.setDrawColor('#333333').setLineWidth(0.3);
                docPDF.line(margin + 10, lineY, margin + 10 + signatureWidth + 10, lineY);
                docPDF.setFontSize(9).setFont(undefined, 'normal');
                docPDF.text('Responsável do Setor', margin + 45, roleY, { align: 'center' });

                const techSignatureX = pageWidth - margin - 15 - signatureWidth;
                docPDF.addImage(techSigDataUrl, 'JPEG', techSignatureX, signatureY, signatureWidth, signatureHeight);
                docPDF.line(techSignatureX - 5, lineY, techSignatureX + signatureWidth + 5, lineY);
                docPDF.text('Responsável Técnico da Empresa', techSignatureX + (signatureWidth/2), roleY, { align: 'center' });

                docPDF.save(`OS-${order.os_numero.split(' ')[0]}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                showToast("Ocorreu um erro ao gerar o PDF.");
            } finally {
                buttonElement.disabled = false;
                buttonElement.textContent = 'Gerar PDF';
            }
        }

        function imageToDataUrl(url, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => reject(new Error(`Falha ao carregar a imagem: ${url}. Erro: ${err}`));
                img.src = url;
            });
        }

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay || e.target.classList.contains('modal-close')) {
                modalOverlay.style.display = 'none';
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.card-move-action')) {
                globalMoveMenu.classList.remove('show');
            }
        });

        board.addEventListener('touchstart', () => {
            if (globalMoveMenu.classList.contains('show')) {
                globalMoveMenu.classList.remove('show');
            }
        }, { passive: true });

        document.addEventListener('wheel', () => {
            if (globalMoveMenu.classList.contains('show')) {
                globalMoveMenu.classList.remove('show');
            }
        }, { passive: true });
        
        initializeBoard();
        listenToOrders();

    </script>
</body>
</html>
