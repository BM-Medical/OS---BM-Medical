<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Inventário</title>
    <script src="favicon-loader.js" type="module"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="auth-guard.js" type="module"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
        .floating-back-btn { 
            position: fixed; bottom: 24px; right: 24px; background-color: #3498db;
            color: white; width: 56px; height: 56px; border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.25); text-decoration: none; 
            transition: all 0.3s ease; z-index: 100; 
        }
        .floating-back-btn:hover { background-color: #2980b9; transform: scale(1.05); }
        .floating-back-btn svg { width: 24px; height: 24px; }
        .contract-section summary::-webkit-details-marker { display: none; }
        .contract-section summary { list-style: none; }
        .uppercase-input { text-transform: uppercase; }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="container mx-auto px-2 sm:px-6 lg:px-8 py-4 flex-grow flex flex-col items-center">
        <header class="w-full text-center py-5">
            <a href="index.html"><img src="./images/logo.png" alt="Logo da Empresa" class="mx-auto w-4/5 max-w-[450px]"></a>
        </header>

        <main class="w-full md:max-w-6xl bg-white p-4 md:p-6 rounded-lg shadow-lg">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6 pb-4 border-b">
                <h1 class="text-2xl font-bold text-gray-800 mb-4 md:mb-0">Gestão de Inventário</h1>
                <button id="add-new-btn" class="w-full md:w-auto px-5 py-2 bg-green-600 text-white text-center font-semibold rounded-lg shadow-md hover:bg-green-700">
                    + Novo Equipamento
                </button>
            </div>
            
            <!-- SEÇÃO DE FILTROS -->
            <div id="filters-section" class="mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-1">
                        <label for="contract-filter" class="block text-sm font-medium text-gray-700">Contrato</label>
                        <select id="contract-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="todos">Todos</option>
                            <option value="Contrato Nº 138/2024">Capão do Leão</option>
                            <option value="Contrato Nº 10/2025">Exército Brasileiro</option>
                        </select>
                    </div>
                    <div class="md:col-span-2">
                        <label for="search-inventory" class="block text-sm font-medium text-gray-700">Buscar por nome, marca, modelo ou serial</label>
                        <input type="text" id="search-inventory" placeholder="Digite aqui para buscar..." class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="flex justify-end mt-4">
                     <button id="search-btn" class="px-6 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">
                        Buscar
                    </button>
                </div>
            </div>

            <div id="inventory-list" class="mt-6 space-y-4">
                <p class="text-center text-gray-500 py-8">Utilize os filtros e clique em "Buscar" para carregar os equipamentos.</p>
            </div>
        </main>
    </div>

    <!-- MODAL DE EXCLUSÃO -->
    <div id="delete-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
        <div class="relative top-20 mx-auto p-5 border w-96 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-lg leading-6 font-medium text-gray-900">Confirmar Exclusão</h3>
                <div class="mt-2 px-7 py-3">
                    <p class="text-sm text-gray-500">
                        Tem certeza que deseja excluir o equipamento <strong id="equipment-name-modal"></strong>? Esta ação não pode ser desfeita.
                    </p>
                </div>
                <div class="items-center px-4 py-3">
                    <button id="cancel-delete-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md mr-2 hover:bg-gray-300">Cancelar</button>
                    <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">Excluir</button>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL DO FORMULÁRIO (NOVO/EDITAR) -->
    <div id="form-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-40">
        <div class="relative top-10 mx-auto p-5 border w-full max-w-2xl shadow-lg rounded-md bg-white">
            <main class="p-4">
                <h1 id="form-title" class="text-2xl font-bold text-gray-800 mb-6 text-center">Adicionar Novo Equipamento</h1>
                <form id="inventory-form">
                    <input type="hidden" id="equipment-id">
                    <div class="space-y-4">
                        <div>
                            <label for="contract" class="block text-sm font-medium text-gray-700">Contrato</label>
                            <select id="contract" name="contract" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                                <option value="" disabled selected>Selecione o contrato</option>
                                <option value="Contrato Nº 138/2024">Capão do Leão</option>
                                <option value="Contrato Nº 10/2025">Exército Brasileiro</option>
                            </select>
                        </div>
                        <div>
                            <label for="name" class="block text-sm font-medium text-gray-700">Nome do Equipamento</label>
                            <input type="text" id="name" name="name" required class="uppercase-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="brand" class="block text-sm font-medium text-gray-700">Marca</label>
                                <input type="text" id="brand" name="brand" required class="uppercase-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="model" class="block text-sm font-medium text-gray-700">Modelo</label>
                                <input type="text" id="model" name="model" required class="uppercase-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="serial" class="block text-sm font-medium text-gray-700">Nº de Série</label>
                                <input type="text" id="serial" name="serial" class="uppercase-input mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            </div>
                            <div>
                                <label for="location" class="block text-sm font-medium text-gray-700">Local / Setor</label>
                                <select id="location" name="location" required class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm" disabled>
                                    <option value="" disabled selected>Selecione um contrato primeiro</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="mt-8 flex justify-end space-x-3">
                        <button type="button" id="cancel-form-btn" class="px-5 py-2 bg-gray-200 text-gray-800 font-semibold rounded-lg hover:bg-gray-300">Cancelar</button>
                        <button type="submit" id="submit-btn" class="px-5 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow-md hover:bg-blue-700">Salvar Equipamento</button>
                    </div>
                </form>
            </main>
        </div>
    </div>

    <a href="index.html" class="floating-back-btn">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
    </a>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, deleteDoc, setDoc, addDoc, query, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- Elementos Globais ---
        const inventoryListContainer = document.getElementById('inventory-list');
        const searchInput = document.getElementById('search-inventory');
        const contractFilter = document.getElementById('contract-filter');
        const searchBtn = document.getElementById('search-btn');

        // --- Lógica de Exclusão ---
        const deleteModal = document.getElementById('delete-modal');
        const equipmentNameModal = document.getElementById('equipment-name-modal');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        let equipmentToDelete = null;

        // --- Lógica do Formulário (Modal) ---
        const formModal = document.getElementById('form-modal');
        const form = document.getElementById('inventory-form');
        const formTitle = document.getElementById('form-title');
        const submitBtn = document.getElementById('submit-btn');
        const contractSelect = document.getElementById('contract');
        const locationSelect = document.getElementById('location');
        const addNewBtn = document.getElementById('add-new-btn');
        const cancelFormBtn = document.getElementById('cancel-form-btn');
        
        const locationsByContract = {
            'Contrato Nº 138/2024': ['PA', 'SECRETARIA DE SAÚDE', 'UBS CENTRAL', 'UBS CASABOM', 'UBS I - PARQUE FRAGATA', 'UBS II - JARDIM AMÉRICA', 'UBS III - JARDIM AMÉRICA', 'CAPS'],
            'Contrato Nº 10/2025': ['GO1', 'GO2', 'GO3', 'GO4', 'PMGUPEL'],
        };

        // --- Funções Principais ---
        function normalizeText(text) {
            if (!text) return '';
            return text
                .toString()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        function renderInventory(equipmentData) {
            inventoryListContainer.innerHTML = '';
            const groupedByContract = equipmentData.reduce((acc, item) => {
                (acc[item.contract] = acc[item.contract] || []).push(item);
                return acc;
            }, {});

            if (Object.keys(groupedByContract).length === 0) {
                inventoryListContainer.innerHTML = `<p class="text-center text-gray-500 py-8">Nenhum equipamento encontrado com os filtros aplicados.</p>`;
                return;
            }

            const contractOrder = ['Contrato Nº 138/2024', 'Contrato Nº 10/2025'];
            contractOrder.forEach(contract => {
                if (!groupedByContract[contract]) return;

                const items = groupedByContract[contract].sort((a,b) => a.name.localeCompare(b.name));
                const section = document.createElement('details');
                section.className = 'contract-section bg-gray-50 rounded-lg open:shadow-lg';
                section.open = true;

                const summary = document.createElement('summary');
                summary.className = 'p-4 cursor-pointer font-bold text-lg text-gray-700';
                summary.textContent = contract;

                const itemList = document.createElement('div');
                itemList.className = 'px-4 pb-4 space-y-2';

                items.forEach(item => {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'p-3 border rounded-md bg-white flex flex-col md:flex-row justify-between items-start md:items-center';
                    itemDiv.innerHTML = `
                        <div class="flex-grow">
                            <p class="font-semibold text-gray-800">${item.name}</p>
                            <p class="text-sm text-gray-500">Marca: ${item.brand} | Modelo: ${item.model}</p>
                            <p class="text-sm text-gray-500">Serial: ${item.serial || 'N/A'} | Local: ${item.location || 'N/A'}</p>
                        </div>
                        <div class="flex space-x-2 mt-2 md:mt-0">
                            <button data-id="${item.id}" data-item='${JSON.stringify(item)}' class="btn-edit px-3 py-1 bg-blue-500 text-white text-xs font-semibold rounded hover:bg-blue-600">Editar</button>
                            <button data-id="${item.id}" data-name="${item.name}" class="btn-delete px-3 py-1 bg-red-500 text-white text-xs font-semibold rounded hover:bg-red-600">Excluir</button>
                        </div>
                    `;
                    itemList.appendChild(itemDiv);
                });

                section.appendChild(summary);
                section.appendChild(itemList);
                inventoryListContainer.appendChild(section);
            });
            
            document.querySelectorAll('.btn-edit').forEach(button => {
                button.addEventListener('click', (e) => {
                    const equipmentData = JSON.parse(e.target.dataset.item);
                    openFormModal(equipmentData);
                });
            });

            document.querySelectorAll('.btn-delete').forEach(button => {
                button.addEventListener('click', (e) => {
                    equipmentToDelete = { id: e.target.dataset.id, name: e.target.dataset.name };
                    equipmentNameModal.textContent = equipmentToDelete.name;
                    deleteModal.classList.remove('hidden');
                });
            });
        }
        
        async function loadAndRenderInventory() {
            inventoryListContainer.innerHTML = `<p class="text-center text-gray-500 py-8">Buscando equipamentos...</p>`;
            
            const selectedContract = contractFilter.value;
            const searchTerm = searchInput.value.trim();

            try {
                const inventoryRef = collection(db, "inventory_equipment");
                let constraints = [];
                if (selectedContract !== 'todos') {
                    constraints.push(where("contract", "==", selectedContract));
                }
                
                const q = constraints.length > 0 ? query(inventoryRef, ...constraints) : inventoryRef;
                const querySnapshot = await getDocs(q);
                
                let equipmentFromDb = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Filtro de texto em JavaScript
                if (searchTerm) {
                    const normalizedSearch = normalizeText(searchTerm);
                    equipmentFromDb = equipmentFromDb.filter(item => 
                        normalizeText(item.name).includes(normalizedSearch) ||
                        normalizeText(item.brand).includes(normalizedSearch) ||
                        normalizeText(item.model).includes(normalizedSearch) ||
                        (item.serial && normalizeText(item.serial).includes(normalizedSearch))
                    );
                }
                
                renderInventory(equipmentFromDb);

            } catch (error) {
                console.error("Erro ao buscar inventário:", error);
                inventoryListContainer.innerHTML = `<p class="text-center text-red-500 py-8">Ocorreu um erro ao buscar os dados.</p>`;
            }
        }


        // --- Funções do Modal de Formulário ---
        function openFormModal(equipmentData = null) {
            form.reset();
            locationSelect.innerHTML = '<option value="" disabled selected>Selecione um contrato primeiro</option>';
            locationSelect.disabled = true;
            
            if (equipmentData) { // MODO EDIÇÃO
                formTitle.textContent = 'Editar Equipamento';
                form.querySelector('#equipment-id').value = equipmentData.id;
                form.contract.value = equipmentData.contract;
                form.name.value = equipmentData.name;
                form.brand.value = equipmentData.brand;
                form.model.value = equipmentData.model;
                form.serial.value = equipmentData.serial || '';
                
                updateLocationOptions();
                form.location.value = equipmentData.location;
                contractSelect.disabled = true;

            } else { // MODO ADIÇÃO
                formTitle.textContent = 'Adicionar Novo Equipamento';
                form.querySelector('#equipment-id').value = '';
                contractSelect.disabled = false;
            }
            formModal.classList.remove('hidden');
        }

        function closeFormModal() {
            formModal.classList.add('hidden');
        }

        function updateLocationOptions() {
            const selectedContract = contractSelect.value;
            locationSelect.innerHTML = '<option value="" disabled selected>Selecione um local</option>';
            locationSelect.disabled = true;

            if (selectedContract && locationsByContract[selectedContract]) {
                const locations = locationsByContract[selectedContract];
                locations.forEach(loc => {
                    const option = document.createElement('option');
                    option.value = loc;
                    option.textContent = loc;
                    locationSelect.appendChild(option);
                });
                locationSelect.disabled = false;
            }
        }
        
        // --- Event Listeners ---
        searchBtn.addEventListener('click', loadAndRenderInventory);
        
        // Listeners de Exclusão
        cancelDeleteBtn.addEventListener('click', () => {
            deleteModal.classList.add('hidden');
            equipmentToDelete = null;
        });
        confirmDeleteBtn.addEventListener('click', async () => {
            if (equipmentToDelete) {
                await deleteDoc(doc(db, "inventory_equipment", equipmentToDelete.id));
                deleteModal.classList.add('hidden');
                equipmentToDelete = null;
                loadAndRenderInventory(); // Recarrega a lista
            }
        });

        // Listeners do Formulário
        addNewBtn.addEventListener('click', () => openFormModal());
        cancelFormBtn.addEventListener('click', closeFormModal);
        contractSelect.addEventListener('change', updateLocationOptions);

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            submitBtn.disabled = true;
            submitBtn.textContent = 'Salvando...';

            const equipmentId = form.querySelector('#equipment-id').value;
            const isEditMode = Boolean(equipmentId);

            const equipmentData = {
                contract: form.contract.value,
                name: form.name.value.toUpperCase(),
                brand: form.brand.value.toUpperCase(),
                model: form.model.value.toUpperCase(),
                serial: form.serial.value.toUpperCase(),
                location: form.location.value
            };

            try {
                if (isEditMode) {
                    const docRef = doc(db, "inventory_equipment", equipmentId);
                    await setDoc(docRef, equipmentData);
                } else {
                    await addDoc(collection(db, "inventory_equipment"), equipmentData);
                }
                closeFormModal();
                loadAndRenderInventory(); // Recarrega a lista
            } catch (error) {
                console.error("Erro ao salvar equipamento: ", error);
                alert("Ocorreu um erro ao salvar. Tente novamente.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Salvar Equipamento';
            }
        });
    </script>
</body>
</html>

