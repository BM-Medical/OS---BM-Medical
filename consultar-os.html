<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Ordens de Serviço</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth-guard.js" type="module"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f6;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex-grow flex flex-col items-center">
        <header class="w-full text-center relative py-5">
            <a href="index.html"><img src="./images/logo.png" alt="Logo da Empresa" class="max-w-xs h-auto mx-auto"></a>
            <button id="logout-button" class="absolute top-5 right-0 bg-red-600 text-white px-3 py-2 rounded-md font-semibold text-sm">Sair</button>
        </header>
        <main class="w-full max-w-lg bg-white p-5 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Consultar Ordens de Serviço</h1>
            <input type="text" id="search-box" placeholder="Digite o número da OS, cliente ou equipamento..." class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none">
            <ul id="os-list" class="mt-4"></ul>
        </main>
    </div>
    <footer class="w-full bg-gray-800 text-white p-5 text-center mt-8">
        <p><strong>BM Medical</strong></p>
    </footer>

    <!-- Botão Voltar Flutuante -->
    <a href="index.html" class="fixed bottom-6 right-6 bg-gray-800 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-700 transition-colors z-40">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
    </a>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Confirmar Ação</h3>
            <p class="text-gray-600 mb-6">Deseja realmente desarquivar a <strong id="os-number-modal"></strong>?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-btn" class="px-6 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">CANCELAR</button>
                <button id="confirm-btn" class="px-6 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">SIM</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const confirmationModal = document.getElementById('confirmation-modal');
        const osNumberModal = document.getElementById('os-number-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        let currentOrderToUnarchive = null;

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        async function loadOrders() {
            try {
                const osList = document.getElementById('os-list');
                osList.innerHTML = '<li>Carregando...</li>';
                const ordersRef = collection(db, "orders");
                const q = query(ordersRef, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                osList.innerHTML = '';
                if (querySnapshot.empty) {
                    osList.innerHTML = '<li>Nenhuma OS encontrada.</li>';
                    return;
                }

                querySnapshot.forEach((doc) => {
                    const order = { id: doc.id, ...doc.data() };
                    const listItem = document.createElement('li');
                    
                    const isArchived = order.status === 'arquivada';
                    const formattedDate = formatDate(order.data_servico || order.data_retirada);

                    const detailsButton = `<button class="px-3 py-2 bg-blue-600 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 btn-details">Detalhes</button>`;
                    const pdfButton = `<button class="px-3 py-2 bg-red-600 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 btn-pdf">Gerar PDF</button>`;
                    const unarchiveButton = `<button class="px-3 py-2 bg-gray-600 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 btn-unarchive">Desarquivar</button>`;

                    let actionsHtml = '';
                    if (isArchived) {
                        actionsHtml = unarchiveButton + detailsButton + pdfButton;
                    } else {
                        actionsHtml = detailsButton + pdfButton;
                    }
                    
                    const cardClasses = isArchived ? 'bg-gray-50' : 'bg-white';
                    const titleClasses = isArchived ? 'text-gray-500' : 'text-blue-600';
                    const textClasses = isArchived ? 'text-gray-400' : 'text-gray-500';

                    listItem.innerHTML = `
                        <div class="rounded-xl shadow-md p-4 mb-4 ${cardClasses}">
                            <div class="mb-3">
                                <h2 class="text-lg font-bold ${titleClasses}">OS: ${order.os_numero || 'N/A'} ${isArchived ? '(Arquivada)' : ''}</h2>
                                <p class="text-sm mt-1 ${textClasses}">Cliente: ${order.cliente || 'N/A'}</p>
                                <p class="text-sm ${textClasses}">Data: ${formattedDate}</p>
                            </div>
                            <div class="border-t border-gray-200 my-2"></div>
                            <div class="flex justify-end items-center pt-2 space-x-2">
                                ${actionsHtml}
                            </div>
                        </div>
                    `;
                    
                    listItem.querySelector('.btn-details').addEventListener('click', () => {
                        window.location.href = `detalhe-os.html?id=${order.id}`;
                    });

                    const pdfBtnElement = listItem.querySelector('.btn-pdf');
                    if (pdfBtnElement) {
                        pdfBtnElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            generatePdfForOrder(order.id, e.target);
                        });
                    }

                    const unarchiveBtnElement = listItem.querySelector('.btn-unarchive');
                    if (unarchiveBtnElement) {
                        unarchiveBtnElement.addEventListener('click', (e) => {
                            e.stopPropagation();
                            currentOrderToUnarchive = { id: order.id, os_numero: order.os_numero, button: e.target };
                            osNumberModal.textContent = `OS ${order.os_numero}`;
                            confirmationModal.classList.remove('hidden');
                        });
                    }

                    osList.appendChild(listItem);
                });
            } catch (error) {
                console.error('Erro ao carregar Ordens de Serviço:', error);
                document.getElementById('os-list').innerHTML = '<li>Erro ao carregar dados.</li>';
            }
        }
        
        async function unarchiveOrder(orderInfo) {
            orderInfo.button.disabled = true;
            const orderRef = doc(db, "orders", orderInfo.id);
            try {
                await updateDoc(orderRef, {
                    status: 'novas',
                    position: Date.now()
                });
                await loadOrders();
            } catch (error) {
                console.error("Erro ao desarquivar a OS:", error);
                alert("Ocorreu um erro ao desarquivar a OS.");
                orderInfo.button.disabled = false;
            } finally {
                closeModal();
            }
        }

        function closeModal() {
            confirmationModal.classList.add('hidden');
            currentOrderToUnarchive = null;
        }

        cancelBtn.addEventListener('click', closeModal);
        confirmBtn.addEventListener('click', () => {
            if (currentOrderToUnarchive) {
                unarchiveOrder(currentOrderToUnarchive);
            }
        });

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                closeModal();
            }
        });

        confirmationModal.addEventListener('touchstart', (e) => {
            if (e.target === confirmationModal) {
                closeModal();
            }
        }, { passive: true });

        document.addEventListener('wheel', () => {
            if (!confirmationModal.classList.contains('hidden')) {
                closeModal();
            }
        }, { passive: true });

        function filterOrders() {
            const searchTerm = document.getElementById('search-box').value.toLowerCase();
            const osItems = document.querySelectorAll('#os-list li');
            osItems.forEach(item => {
                const text = item.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    item.style.display = 'block';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        document.getElementById('search-box').addEventListener('keyup', filterOrders);
        window.onload = loadOrders;

        function imageToDataUrl(url, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => reject(new Error(`Falha ao carregar a imagem: ${url}. Erro: ${err}`));
                img.src = url;
            });
        }

        async function generatePdfForOrder(orderId, buttonElement) {
            buttonElement.disabled = true;
            try {
                const logoDataUrl = await imageToDataUrl('./images/logo.png', 0.9);
                const techSigDataUrl = await imageToDataUrl('./images/assinatura-tecnico.png', 0.7);
                const docRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) { throw new Error('OS não encontrada.'); }
                const order = docSnap.data();
                const { jsPDF } = window.jspdf;
                const docPDF = new jsPDF();
                const pageHeight = docPDF.internal.pageSize.height;
                const pageWidth = docPDF.internal.pageSize.width;
                const margin = 15;
                const signatureDataUrl = order.signature_data;
                function drawSection(title, yPos) {
                    docPDF.setFontSize(11).setFont(undefined, 'bold');
                    docPDF.text(title, margin, yPos);
                    docPDF.setLineWidth(0.2).line(margin, yPos + 2, pageWidth - margin, yPos + 2);
                    return yPos + 8;
                }
                docPDF.addImage(logoDataUrl, 'JPEG', margin, 12, 80, 32);
                docPDF.setFontSize(10).setFont(undefined, 'bold');
                docPDF.text('BM MEDICAL', pageWidth - margin, 15, { align: 'right' });
                docPDF.setFontSize(8).setFont(undefined, 'normal');
                docPDF.text('Manutenção Hospitalar', pageWidth - margin, 20, { align: 'right' });
                docPDF.text('CNPJ: 48.673.158/0001-59', pageWidth - margin, 25, { align: 'right' });
                docPDF.text('Av. Duque de Caxias, 915-B403, Pelotas-RS', pageWidth - margin, 30, { align: 'right' });
                docPDF.text('Fone: (51) 99377-5933', pageWidth - margin, 35, { align: 'right' });
                docPDF.setFontSize(16).setFont(undefined, 'bold');
                docPDF.text(`Ordem de Serviço: ${order.os_numero}`, pageWidth / 2, 55, { align: 'center' });
                let yPosition = 65;
                yPosition = drawSection('Dados do Cliente', yPosition);
                docPDF.setFontSize(10).setFont(undefined, 'normal');
                docPDF.text(`Contrato: ${order.contrato || 'N/A'}`, margin, yPosition);
                yPosition += 5;
                docPDF.text(`Cliente: ${order.cliente || 'N/A'}`, margin, yPosition);
                yPosition += 10;
                yPosition = drawSection('Dados do Equipamento', yPosition);
                docPDF.text(`Equipamento: ${order.equipamento}`, margin, yPosition);
                yPosition += 7;
                docPDF.text(`Modelo: ${order.modelo}`, margin, yPosition);
                yPosition += 7;
                docPDF.text(`Serial: ${order.serial}`, margin, yPosition);
                yPosition += 10;
                yPosition = drawSection('Dados do Atendimento', yPosition);
                docPDF.text(`Data do Serviço: ${order.data_servico || order.data_retirada}`, margin, yPosition);
                yPosition += 7;
                docPDF.text(`Hora de Chegada: ${order.hora_chegada || 'N/A'}`, margin, yPosition);
                yPosition += 7;
                docPDF.text(`Hora de Saída: ${order.hora_saida || 'N/A'}`, margin, yPosition);
                yPosition += 10;
                yPosition = drawSection('Serviços Realizados', yPosition);
                const servicosLines = docPDF.splitTextToSize(order.servicos_realizados || '', pageWidth - (margin * 2));
                docPDF.text(servicosLines, margin, yPosition);
                yPosition += (servicosLines.length * 5) + 10;
                yPosition = drawSection('Peças Utilizadas', yPosition);
                const pecasLines = docPDF.splitTextToSize(order.pecas_utilizadas || 'Nenhuma', pageWidth - (margin * 2));
                docPDF.text(pecasLines, margin, yPosition);
                const signatureY = pageHeight - 70;
                const signatureHeight = 30;
                const signatureWidth = 70;
                const roleY = signatureY + signatureHeight + 10;
                const lineY = roleY - 5;
                if (signatureDataUrl && signatureDataUrl.length > 200) {
                    docPDF.addImage(signatureDataUrl, 'JPEG', 20, signatureY, signatureWidth, signatureHeight);
                }
                docPDF.setLineWidth(0.3);
                docPDF.line(20, lineY, 20 + signatureWidth, lineY);
                docPDF.setFontSize(10).setFont(undefined, 'normal');
                docPDF.text('Responsável do Setor', 55, roleY, { align: 'center' });
                const techSignatureX = pageWidth - 20 - signatureWidth;
                docPDF.addImage(techSigDataUrl, 'JPEG', techSignatureX, signatureY, signatureWidth, signatureHeight);
                docPDF.setLineWidth(0.3);
                docPDF.line(techSignatureX, lineY, techSignatureX + signatureWidth, lineY);
                docPDF.setFontSize(10).setFont(undefined, 'normal');
                docPDF.text('Responsável Técnico da Empresa', pageWidth - 55, roleY, { align: 'center' });
                docPDF.save(`OS-${order.os_numero.split(' ')[0]}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF.");
            } finally {
                buttonElement.disabled = false;
            }
        }
    </script>
</body>
</html>
