<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Consultar Ordens de Serviço</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth-guard.js" type="module"></script>
    <style>
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #f4f7f6;
        }
        .filters-enter {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out;
        }
        .filters-enter-active {
            max-height: 500px; /* Altura suficiente para os filtros */
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">
    <div class="container mx-auto p-4 flex-grow flex flex-col items-center">
        <header class="w-full text-center relative py-5">
            <a href="index.html"><img src="./images/logo.png" alt="Logo da Empresa" class="max-w-xs h-auto mx-auto"></a>
            <button id="logout-button" class="absolute top-5 right-0 bg-red-600 text-white px-3 py-2 rounded-md font-semibold text-sm">Sair</button>
        </header>
        <main class="w-full max-w-lg bg-white p-5 rounded-lg shadow-lg">
            <h1 class="text-2xl font-bold text-gray-800 mb-4 text-center">Consultar Ordens de Serviço</h1>

            <!-- Secção de Filtros -->
            <button id="toggle-filters-btn" class="w-full mb-4 text-left text-blue-600 font-semibold p-2 rounded-md hover:bg-blue-50">
                Mostrar/Ocultar Filtros Avançados
            </button>
            <div id="filters-section" class="filters-enter">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4">
                    <div>
                        <label for="status-filter" class="block text-sm font-medium text-gray-700">Status</label>
                        <select id="status-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="todos">Todos</option>
                            <option value="abertas">Abertas</option>
                            <option value="finalizada">Concluídas</option>
                            <option value="arquivada">Arquivadas</option>
                        </select>
                    </div>
                    <div>
                        <label for="contract-filter" class="block text-sm font-medium text-gray-700">Contrato</label>
                        <select id="contract-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                            <option value="todos">Todos</option>
                            <option value="Contrato N° 03/2024">Autoclave BAUMER HE-UFPEL</option>
                            <option value="Contrato Nº 138/2024">Capão do Leão</option>
                            <option value="Contrato Nº 10/2025">Exército Brasileiro</option>
                        </select>
                    </div>
                    <div>
                        <label for="date-filter" class="block text-sm font-medium text-gray-700">Data de Abertura</label>
                        <input type="date" id="date-filter" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                    <div>
                        <label for="text-search" class="block text-sm font-medium text-gray-700">Nº da OS ou Equipamento</label>
                        <input type="text" id="text-search" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm">
                    </div>
                </div>
                <div class="flex justify-end space-x-3 mt-4 pt-4 border-t">
                    <button id="clear-filters-btn" class="px-4 py-2 bg-gray-200 text-gray-700 text-sm font-semibold rounded-lg hover:bg-gray-300">Limpar</button>
                    <button id="apply-filters-btn" class="px-4 py-2 bg-purple-600 text-white text-sm font-semibold rounded-lg hover:bg-purple-700">Aplicar Filtros</button>
                </div>
            </div>
            <!-- Fim da Secção de Filtros -->

            <ul id="os-list" class="mt-4"></ul>
        </main>
    </div>
    <footer class="w-full bg-gray-800 text-white p-5 text-center mt-8">
        <p><strong>BM Medical</strong></p>
    </footer>

    <!-- Botão Voltar Flutuante -->
    <a href="index.html" class="fixed bottom-6 right-6 bg-gray-800 text-white w-14 h-14 rounded-full flex items-center justify-center shadow-lg hover:bg-gray-700 transition-colors z-40">
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
    </a>

    <!-- Modal de Confirmação -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-60 flex items-center justify-center p-4 hidden z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h3 class="text-lg font-semibold text-gray-800 mb-2">Confirmar Ação</h3>
            <p class="text-gray-600 mb-6">Deseja realmente desarquivar a <strong id="os-number-modal"></strong>?</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-btn" class="px-6 py-2 text-gray-700 bg-gray-200 rounded-lg hover:bg-gray-300">CANCELAR</button>
                <button id="confirm-btn" class="px-6 py-2 text-white bg-green-600 rounded-lg hover:bg-green-700">SIM</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, getDocs, doc, getDoc, updateDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyC8L8dTkuL_KxvW_-m7V3c0UmYwV-gbQfE",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const confirmationModal = document.getElementById('confirmation-modal');
        const osNumberModal = document.getElementById('os-number-modal');
        const cancelBtn = document.getElementById('cancel-btn');
        const confirmBtn = document.getElementById('confirm-btn');
        let currentOrderToUnarchive = null;
        let allOrders = []; 

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const [year, month, day] = dateString.split('-');
            return `${day}/${month}/${year}`;
        }

        function normalizeText(text) {
            if (!text) return '';
            return text
                .toString()
                .toLowerCase()
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "");
        }

        async function fetchAllOrders() {
            try {
                const osList = document.getElementById('os-list');
                osList.innerHTML = '<li>Carregando...</li>';
                const ordersRef = collection(db, "orders");
                const q = query(ordersRef, orderBy("createdAt", "desc"));
                const querySnapshot = await getDocs(q);
                
                allOrders = [];
                querySnapshot.forEach((doc) => {
                    allOrders.push({ id: doc.id, ...doc.data() });
                });
                
                renderOrders(allOrders);

            } catch (error) {
                console.error('Erro ao carregar Ordens de Serviço:', error);
                document.getElementById('os-list').innerHTML = '<li>Erro ao carregar dados.</li>';
            }
        }

        function renderOrders(orders) {
            const osList = document.getElementById('os-list');
            osList.innerHTML = '';
            if (orders.length === 0) {
                osList.innerHTML = '<li>Nenhuma OS encontrada com os filtros aplicados.</li>';
                return;
            }

            orders.forEach((order) => {
                const listItem = document.createElement('li');
                
                const isArchived = order.status === 'arquivada';
                const isFinalizada = order.status === 'finalizada';
                const formattedDate = formatDate(order.data_servico || order.data_retirada);

                const detailsButton = `<button class="px-3 py-2 bg-blue-600 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 btn-details">Detalhes</button>`;
                const pdfButton = `<button class="px-3 py-2 bg-red-600 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-400 focus:ring-opacity-75 btn-pdf">Gerar PDF</button>`;
                const unarchiveButton = `<button class="px-3 py-2 bg-gray-600 text-white text-xs font-semibold rounded-lg shadow-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-75 btn-unarchive">Desarquivar</button>`;

                let actionsHtml = '';
                let statusText = '';
                let cardClasses = 'bg-white';
                let titleClasses = 'text-blue-600';
                let textClasses = 'text-gray-500';

                if (isFinalizada) {
                    actionsHtml = detailsButton + pdfButton;
                    statusText = '(Concluída)';
                    titleClasses = 'text-green-600';
                } else if (isArchived) {
                    actionsHtml = unarchiveButton + detailsButton + pdfButton;
                    statusText = '(Arquivada)';
                    cardClasses = 'bg-gray-50';
                    titleClasses = 'text-gray-500';
                    textClasses = 'text-gray-400';
                } else {
                    actionsHtml = detailsButton + pdfButton;
                }

                listItem.innerHTML = `
                    <div class="rounded-xl shadow-md p-4 mb-4 ${cardClasses}">
                        <div class="mb-3">
                            <h2 class="text-lg font-bold ${titleClasses}">OS: ${order.os_numero || 'N/A'} ${statusText}</h2>
                            <p class="text-sm mt-1 ${textClasses}">Cliente: ${order.cliente || 'N/A'}</p>
                            <p class="text-sm ${textClasses}">Data: ${formattedDate}</p>
                        </div>
                        <div class="border-t border-gray-200 my-2"></div>
                        <div class="flex justify-end items-center pt-2 space-x-2">
                            ${actionsHtml}
                        </div>
                    </div>
                `;
                
                listItem.querySelector('.btn-details').addEventListener('click', () => {
                    window.location.href = `detalhe-os.html?id=${order.id}`;
                });

                const pdfBtnElement = listItem.querySelector('.btn-pdf');
                if (pdfBtnElement) {
                    pdfBtnElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        generatePdfForOrder(order.id, e.target);
                    });
                }

                const unarchiveBtnElement = listItem.querySelector('.btn-unarchive');
                if (unarchiveBtnElement) {
                    unarchiveBtnElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        currentOrderToUnarchive = { id: order.id, os_numero: order.os_numero, button: e.target };
                        osNumberModal.textContent = `OS ${order.os_numero}`;
                        confirmationModal.classList.remove('hidden');
                    });
                }

                osList.appendChild(listItem);
            });
        }

        function applyFilters() {
            const status = document.getElementById('status-filter').value;
            const contract = document.getElementById('contract-filter').value;
            const date = document.getElementById('date-filter').value;
            const text = document.getElementById('text-search').value.trim();

            let filteredOrders = allOrders;

            if (status !== 'todos') {
                if (status === 'abertas') {
                    const closedStatus = ['finalizada', 'arquivada'];
                    filteredOrders = filteredOrders.filter(order => !closedStatus.includes(order.status));
                } else {
                    filteredOrders = filteredOrders.filter(order => order.status === status);
                }
            }

            if (contract !== 'todos') {
                filteredOrders = filteredOrders.filter(order => order.contrato === contract);
            }

            if (date) {
                filteredOrders = filteredOrders.filter(order => {
                    const orderDate = order.data_servico || order.data_retirada;
                    return orderDate === date;
                });
            }

            if (text) {
                const normalizedText = normalizeText(text);
                filteredOrders = filteredOrders.filter(order => 
                    (normalizeText(order.os_numero).includes(normalizedText)) ||
                    (normalizeText(order.equipamento).includes(normalizedText))
                );
            }

            renderOrders(filteredOrders);
        }

        document.getElementById('apply-filters-btn').addEventListener('click', applyFilters);

        document.getElementById('clear-filters-btn').addEventListener('click', () => {
            document.getElementById('status-filter').value = 'todos';
            document.getElementById('contract-filter').value = 'todos';
            document.getElementById('date-filter').value = '';
            document.getElementById('text-search').value = '';
            renderOrders(allOrders);
        });

        const toggleBtn = document.getElementById('toggle-filters-btn');
        const filtersSection = document.getElementById('filters-section');
        toggleBtn.addEventListener('click', () => {
            filtersSection.classList.toggle('filters-enter-active');
        });

        async function unarchiveOrder(orderInfo) {
            orderInfo.button.disabled = true;
            const orderRef = doc(db, "orders", orderInfo.id);
            try {
                await updateDoc(orderRef, {
                    status: 'novas',
                    position: Date.now()
                });
                await fetchAllOrders(); 
            } catch (error) {
                console.error("Erro ao desarquivar a OS:", error);
                alert("Ocorreu um erro ao desarquivar a OS.");
                orderInfo.button.disabled = false;
            } finally {
                closeModal();
            }
        }

        function closeModal() {
            confirmationModal.classList.add('hidden');
            currentOrderToUnarchive = null;
        }

        cancelBtn.addEventListener('click', closeModal);
        confirmBtn.addEventListener('click', () => {
            if (currentOrderToUnarchive) {
                unarchiveOrder(currentOrderToUnarchive);
            }
        });

        confirmationModal.addEventListener('click', (e) => {
            if (e.target === confirmationModal) {
                closeModal();
            }
        });

        window.onload = fetchAllOrders;

        // --- Funções de PDF ---
        function imageToDataUrl(url, quality = 0.7) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.crossOrigin = 'Anonymous';
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.fillStyle = '#FFFFFF';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = (err) => reject(new Error(`Falha ao carregar a imagem: ${url}. Erro: ${err}`));
                img.src = url;
            });
        }

        async function generatePdfForOrder(orderId, buttonElement) {
            buttonElement.disabled = true;
            buttonElement.textContent = 'Gerando...';
            try {
                const logoDataUrl = await imageToDataUrl('./images/logo.png', 0.9);
                const techSigDataUrl = await imageToDataUrl('./images/assinatura-tecnico.png', 0.7);
                const docRef = doc(db, "orders", orderId);
                const docSnap = await getDoc(docRef);
                if (!docSnap.exists()) { throw new Error('OS não encontrada.'); }
                const order = docSnap.data();
                
                const { jsPDF } = window.jspdf;
                const docPDF = new jsPDF();
                const pageHeight = docPDF.internal.pageSize.height;
                const pageWidth = docPDF.internal.pageSize.width;
                const margin = 15;
                let yPosition = 10;

                // --- Cabeçalho ---
                docPDF.addImage(logoDataUrl, 'JPEG', margin, yPosition, 72, 32);
                docPDF.setFontSize(8).setFont(undefined, 'normal');
                docPDF.text('BM MEDICAL', pageWidth - margin, yPosition + 5, { align: 'right' });
                docPDF.text('Manutenção Hospitalar', pageWidth - margin, yPosition + 9, { align: 'right' });
                docPDF.text('CNPJ: 48.673.158/0001-59', pageWidth - margin, yPosition + 13, { align: 'right' });
                docPDF.text('Av. Duque de Caxias, 915-B403, Pelotas-RS', pageWidth - margin, yPosition + 17, { align: 'right' });
                docPDF.text('Fone: (51) 99377-5933', pageWidth - margin, yPosition + 21, { align: 'right' });
                yPosition += 38;

                // --- Título da OS ---
                docPDF.setFontSize(20).setFont(undefined, 'bold');
                docPDF.text(`OS ${order.os_numero}`, pageWidth / 2, yPosition, { align: 'center' });
                yPosition += 8;

                if (order.tipo_manutencao) {
                    docPDF.setFontSize(12).setFont(undefined, 'normal');
                    const typeText = order.tipo_manutencao === 'preventiva' ? 'MP - Manutenção Preventiva' : 'MC - Manutenção Corretiva';
                    docPDF.text(typeText, pageWidth / 2, yPosition, { align: 'center' });
                }
                yPosition += 12;

                // --- Função para desenhar seções ---
                const drawSection = (title, contentCallback) => {
                    const startY = yPosition;
                    const contentY = startY + 10;
                    
                    const finalY = contentCallback(contentY, true); 
                    const contentHeight = finalY - contentY;
                    const boxHeight = contentHeight + 18; 
                    
                    docPDF.setDrawColor('#e0e0e0').setFillColor('#ffffff');
                    docPDF.roundedRect(margin, startY - 5, pageWidth - (margin * 2), boxHeight, 3, 3, 'FD');
                    
                    docPDF.setFontSize(14).setTextColor('#3498db').setFont(undefined, 'bold');
                    docPDF.text(title, margin + 4, startY);
                    docPDF.setDrawColor('#3498db').setLineWidth(0.5).line(margin + 4, startY + 2, pageWidth - margin - 4, startY + 2);

                    docPDF.setFontSize(12).setTextColor('#000000').setFont(undefined, 'normal');
                    contentCallback(contentY, false);

                    yPosition = startY + boxHeight + 3;
                };

                // --- Seções ---
                drawSection('Dados do Cliente', (currentY, isDryRun) => {
                    let y = currentY;
                    if (!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Contrato:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.contrato || 'N/A', margin + 27, y);
                        y += 6;
                        docPDF.setFont(undefined, 'bold').text('Cliente:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.cliente || 'N/A', margin + 27, y);
                        y += 6;
                        docPDF.setFont(undefined, 'bold').text('Endereço:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.endereco || 'N/A', margin + 27, y);
                    }
                    return y + 18;
                });

                drawSection('Dados do Equipamento', (currentY, isDryRun) => {
                    let y = currentY;
                    const equipLines = docPDF.splitTextToSize(order.equipamento || 'N/A', pageWidth - margin * 2 - 40);
                    if (!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Equipamento:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(equipLines, margin + 34, y);
                    }
                    y += 6 * equipLines.length;

                    if(!isDryRun) {
                        docPDF.setFont(undefined, 'bold').text('Marca:', margin + 4, y);
                        docPDF.setFont(undefined, 'normal').text(order.marca || 'N/A', margin + 19, y);
                        docPDF.setFont(undefined, 'bold').text('Modelo:', margin + 70, y);
                        docPDF.setFont(undefined, 'normal').text(order.modelo || 'N/A', margin + 87, y);
                        docPDF.setFont(undefined, 'bold').text('Serial:', margin + 130, y);
                        docPDF.setFont(undefined, 'normal').text(order.serial || 'N/A', margin + 144, y);
                    }
                    return y + 6;
                });
                
                drawSection('Atendimento', (currentY, isDryRun) => {
                    const ufpelContract = 'Contrato N° 03/2024';
                    const capaoContract = 'Contrato Nº 138/2024';
                    const exercitoContract = 'Contrato Nº 10/2025';
                    let y = currentY;

                    if (order.contrato === ufpelContract) {
                        if (!isDryRun) {
                            docPDF.setFont(undefined, 'bold').text('Data do Serviço:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_servico), margin + 35, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Hora de Chegada:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(order.hora_chegada || 'N/A', margin + 35, y);
                            docPDF.setFont(undefined, 'bold').text('Hora de Saída:', margin + 80, y);
                            docPDF.setFont(undefined, 'normal').text(order.hora_saida || 'N/A', margin + 105, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Local:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text('CME / HE-UFPEL', margin + 20, y);
                        }
                        y += 18; 
                    } else if (order.contrato === capaoContract || order.contrato === exercitoContract) {
                        if (!isDryRun) {
                            docPDF.setFont(undefined, 'bold').text('Data da Retirada:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_retirada), margin + 40, y);
                            docPDF.setFont(undefined, 'bold').text('Data da Devolução:', margin + 80, y);
                            docPDF.setFont(undefined, 'normal').text(formatDate(order.data_devolucao), margin + 120, y);
                            y += 6;
                            docPDF.setFont(undefined, 'bold').text('Local:', margin + 4, y);
                            docPDF.setFont(undefined, 'normal').text(order.local_atendimento || 'N/A', margin + 19, y);
                        }
                        y += 12; 
                    }
                    return y;
                });

                drawSection('Descrição dos Serviços Realizados', (currentY, isDryRun) => {
                    const text = order.servicos_realizados || 'Não informado.';
                    const lines = docPDF.splitTextToSize(text, pageWidth - (margin * 2) - 8);
                    if (!isDryRun) docPDF.text(lines, margin + 4, currentY);
                    return currentY + (lines.length * 6);
                });

                drawSection('Peças Utilizadas', (currentY, isDryRun) => {
                    const text = order.pecas_utilizadas || 'Nenhuma.';
                    const lines = docPDF.splitTextToSize(text, pageWidth - (margin * 2) - 8);
                    if (!isDryRun) docPDF.text(lines, margin + 4, currentY);
                    return currentY + (lines.length * 6);
                });

                // --- Assinaturas (no final da página) ---
                const signatureY = pageHeight - 60;
                const signatureHeight = 25;
                const signatureWidth = 60;
                const roleY = signatureY + signatureHeight + 2;
                const lineY = roleY - 3;
                
                if (order.signature_data && order.signature_data.length > 200) {
                    docPDF.addImage(order.signature_data, 'JPEG', margin + 15, signatureY, signatureWidth, signatureHeight);
                }
                docPDF.setDrawColor('#333333').setLineWidth(0.3);
                docPDF.line(margin + 10, lineY, margin + 10 + signatureWidth + 10, lineY);
                docPDF.setFontSize(9).setFont(undefined, 'normal');
                docPDF.text('Responsável do Setor', margin + 45, roleY, { align: 'center' });

                const techSignatureX = pageWidth - margin - 15 - signatureWidth;
                docPDF.addImage(techSigDataUrl, 'JPEG', techSignatureX, signatureY, signatureWidth, signatureHeight);
                docPDF.line(techSignatureX - 5, lineY, techSignatureX + signatureWidth + 5, lineY);
                docPDF.text('Responsável Técnico da Empresa', techSignatureX + (signatureWidth/2), roleY, { align: 'center' });

                docPDF.save(`OS-${order.os_numero.split(' ')[0]}.pdf`);
            } catch (error) {
                console.error("Erro ao gerar PDF:", error);
                alert("Ocorreu um erro ao gerar o PDF.");
            } finally {
                buttonElement.disabled = false;
                buttonElement.textContent = 'Gerar PDF';
            }
        }

    </script>
</body>
</html>
