<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Calibrações - BM Medical</title>
    <script src="favicon-loader.js" type="module"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="auth-guard.js" type="module"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; color: #1f2937; }
        /* Tema Vermelho (Heufpel) */
        .theme-text { color: #b91c1c; }
        .theme-bg { background-color: #b91c1c; }
        .theme-bg-hover:hover { background-color: #991b1b; }
        .theme-border { border-color: #b91c1c; }
        
        .tab-btn.active { border-bottom: 2px solid #b91c1c; color: #b91c1c; font-weight: 600; }
        .tab-btn { 
            color: #6b7280; 
            border-bottom: 2px solid transparent; 
            transition: all 0.2s; 
            white-space: nowrap; 
        }
        
        .form-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e5e7eb; }
        .form-section h3 { color: #b91c1c; font-weight: 600; border-bottom: 1px solid #eee; padding-bottom: 8px; margin-bottom: 15px; }
        
        .input-std { width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; }
        .input-std:focus { outline: none; border-color: #b91c1c; ring: 1px solid #b91c1c; }
        
        .search-result-item:hover { background-color: #f3f4f6; cursor: pointer; }

        @media (max-width: 768px) {
            .input-std { font-size: 16px; } 
        }
    </style>
</head>
<body class="flex flex-col min-h-screen">

    <header class="bg-white shadow-sm sticky top-0 z-30">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-3 w-full md:w-auto">
                <a href="index.html"><img src="./images/logo.png" alt="Logo" class="h-10 w-auto"></a>
                <div class="h-8 w-px bg-gray-300"></div>
                <div>
                    <h1 class="text-xl font-bold text-gray-800">Calibrações</h1>
                    <p class="text-xs text-gray-500">Contrato EBSERH / HE-UFPEL</p>
                </div>
            </div>
            <div class="flex space-x-4 w-full md:w-auto overflow-x-auto pb-1 md:pb-0 scrollbar-hide">
                <button onclick="switchTab('dashboard')" id="tab-dashboard" class="tab-btn active px-3 py-2">Dashboard</button>
                <button onclick="switchTab('new')" id="tab-new" class="tab-btn px-3 py-2">Novo Laudo</button>
                <button onclick="switchTab('standards')" id="tab-standards" class="tab-btn px-3 py-2">Padrões e Equipamentos</button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6 max-w-6xl flex-grow">
        
        <!-- ABA 1: DASHBOARD -->
        <div id="view-dashboard" class="animate-fade-in">
            <div class="bg-white rounded shadow p-4 mb-6">
                <h2 class="text-lg font-bold mb-4">Histórico de Certificados</h2>
                <div class="flex flex-col md:flex-row gap-2 mb-4">
                    <input type="text" id="search-cert" placeholder="Buscar por Nº, Equipamento ou Setor..." class="input-std w-full md:max-w-md">
                    <button class="theme-bg text-white px-4 py-2 md:py-0 rounded hover:opacity-90 font-bold">Buscar</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm min-w-[600px]">
                        <thead class="bg-gray-50 text-gray-600 uppercase border-b">
                            <tr>
                                <th class="p-3">Nº Certificado</th>
                                <th class="p-3">Equipamento</th>
                                <th class="p-3">Data Calib.</th>
                                <th class="p-3">Validade</th>
                                <th class="p-3">Status</th>
                                <th class="p-3 text-right">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="history-table-body">
                            <tr><td colspan="6" class="p-4 text-center text-gray-500">Nenhum certificado encontrado.</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ABA 2: NOVO LAUDO -->
        <div id="view-new" class="hidden animate-fade-in">
            <form id="calibration-form">
                
                <!-- 1. Identificação -->
                <div class="form-section">
                    <h3>1. Identificação do Equipamento</h3>
                    
                    <div id="equip-search-panel" class="mb-4">
                        <p class="text-xs text-gray-500 mb-2 font-bold">Buscar no Inventário:</p>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-2">
                            <input type="text" id="s-name" placeholder="Nome (Ex: Monitor)" class="input-std">
                            <input type="text" id="s-brand" placeholder="Marca/Modelo" class="input-std">
                            <input type="text" id="s-serial" placeholder="Nº de Série" class="input-std">
                        </div>
                        <button type="button" id="btn-search-equip" class="w-full md:w-auto theme-bg text-white px-4 py-2 rounded text-sm font-bold hover:opacity-90 mt-2 md:mt-0">
                            Pesquisar Equipamento
                        </button>
                    </div>

                    <div id="equip-search-results" class="hidden bg-gray-50 border border-gray-200 rounded max-h-48 overflow-y-auto mb-4 p-2"></div>

                    <div id="equip-details-container" class="hidden relative bg-gray-50 p-4 rounded border border-dashed border-gray-300">
                        <button type="button" id="btn-clear-equip" class="absolute top-2 right-2 text-xs text-red-500 hover:underline bg-white px-2 py-1 rounded shadow-sm">Limpar / Nova Busca</button>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4 md:mt-0">
                            <div><label class="block text-xs font-bold mb-1">Equipamento (Tipo)</label><input type="text" name="equipName" id="f-name" required class="input-std uppercase bg-gray-100" readonly></div>
                            <div><label class="block text-xs font-bold mb-1">Marca</label><input type="text" name="equipBrand" id="f-brand" required class="input-std uppercase bg-gray-100" readonly></div>
                            <div><label class="block text-xs font-bold mb-1">Modelo</label><input type="text" name="equipModel" id="f-model" required class="input-std uppercase bg-gray-100" readonly></div>
                            <div><label class="block text-xs font-bold mb-1">Nº de Série</label><input type="text" name="equipSerial" id="f-serial" required class="input-std uppercase bg-gray-100" readonly></div>
                            <div><label class="block text-xs font-bold mb-1">Patrimônio/Tag</label><input type="text" name="equipTag" id="f-tag" class="input-std uppercase bg-gray-100" readonly></div>
                            <div><label class="block text-xs font-bold mb-1">Setor Solicitante</label><input type="text" name="requester" id="f-sector" class="input-std uppercase bg-gray-100" readonly></div>
                        </div>
                    </div>

                    <div class="text-right mt-2">
                        <button type="button" id="btn-manual-equip" class="text-xs text-blue-600 font-bold hover:underline">Equipamento não encontrado? Inserir Manualmente</button>
                    </div>
                </div>

                <!-- 2. Condições e Padrões -->
                <div class="form-section">
                    <h3>2. Condições e Rastreabilidade</h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                        <div><label class="block text-xs font-bold mb-1">Data Execução</label><input type="date" id="dateExec" required class="input-std"></div>
                        <div><label class="block text-xs font-bold mb-1">Validade</label>
                            <select id="validityMonths" class="input-std">
                                <option value="12">12 Meses (1 Ano)</option>
                                <option value="6">6 Meses</option>
                            </select>
                        </div>
                        <div><label class="block text-xs font-bold mb-1">Temp. (°C)</label><input type="number" step="0.1" name="envTemp" class="input-std" value="23.0"></div>
                        <div><label class="block text-xs font-bold mb-1">Umidade (%)</label><input type="number" name="envHum" class="input-std" value="55"></div>
                    </div>
                    
                    <div class="border-t pt-4">
                        <label class="block text-xs font-bold mb-2">Padrões Utilizados (Selecione todos os aplicáveis ao laudo)</label>
                        <select id="standards-select" multiple class="input-std h-32 md:h-24 bg-gray-50 text-sm border-2 border-dashed focus:border-red-500">
                            <!-- Injetado via JS -->
                        </select>
                        <p class="text-xs text-gray-500 mt-1">Segure Ctrl (PC) ou toque para selecionar vários.</p>
                    </div>
                </div>

                <!-- 3. RESULTADOS -->
                <div id="test-groups-container"></div>

                <div class="mb-6">
                    <button type="button" id="btn-add-group" class="border-2 border-dashed border-gray-300 w-full py-4 md:py-3 text-gray-500 font-bold hover:bg-gray-50 hover:border-gray-400 rounded transition flex items-center justify-center gap-2">
                        <span class="text-xl">+</span> Adicionar Grupo de Teste
                    </button>
                </div>

                <!-- 4. Conclusão -->
                <div class="form-section bg-gray-50">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-2">
                        <h3 class="mb-0">Conclusão</h3>
                        <div class="text-xl font-bold self-end md:self-auto" id="final-status-display">PENDENTE</div>
                    </div>
                    <div class="mt-4">
                        <label class="block text-xs font-bold mb-1">Observações / Restrições</label>
                        <textarea name="observations" rows="3" class="input-std"></textarea>
                    </div>
                </div>

                <!-- Botões de Ação -->
                <div class="sticky bottom-4 z-20 flex flex-col md:flex-row gap-2 bg-f3f4f6 md:bg-transparent py-2 md:py-0">
                    <button type="button" id="btn-preview-pdf" class="flex-1 bg-gray-700 text-white font-bold py-3 rounded shadow hover:bg-gray-800 text-sm md:text-base">
                        Gerar PDF (Visualizar)
                    </button>
                    <button type="submit" class="flex-1 theme-bg text-white font-bold py-3 rounded shadow hover:opacity-90 text-sm md:text-base">
                        Salvar Certificado Final
                    </button>
                </div>
            </form>
        </div>

        <!-- ABA 3: PADRÕES E EQUIPAMENTOS -->
        <div id="view-standards" class="hidden animate-fade-in">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Coluna Esquerda: Padrões -->
                <div>
                    <div class="form-section">
                        <h3>Cadastrar Padrão (Instrumento)</h3>
                        <form id="standard-form" class="grid grid-cols-1 gap-3">
                            <div><label class="text-xs font-bold">Nome do Padrão</label><input type="text" id="std-name" class="input-std" placeholder="Ex: Analisador ESA620" required></div>
                            <div><label class="text-xs font-bold">Nº Certificado</label><input type="text" id="std-cert" class="input-std" required></div>
                            <div><label class="text-xs font-bold">Validade</label><input type="date" id="std-validity" class="input-std" required></div>
                            <button type="submit" class="theme-bg text-white px-4 py-3 md:py-2 rounded font-bold w-full mt-2">Salvar Padrão</button>
                        </form>
                    </div>
                    <div class="bg-white rounded shadow overflow-hidden h-64 overflow-y-auto">
                        <table class="w-full text-xs text-left">
                            <thead class="bg-gray-100 sticky top-0"><tr><th class="p-2">Nome</th><th class="p-2">Validade</th><th class="p-2"></th></tr></thead>
                            <tbody id="standards-list-body"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Coluna Direita: Equipamentos do Cliente -->
                <div>
                    <div class="form-section">
                        <h3>Cadastrar Equipamento (Inventário)</h3>
                        <form id="equipment-form" class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <div class="sm:col-span-2"><label class="text-xs font-bold">Equipamento (Tipo)</label><input type="text" id="inv-name" class="input-std uppercase" placeholder="Ex: MONITOR" required></div>
                            <div><label class="text-xs font-bold">Marca</label><input type="text" id="inv-brand" class="input-std uppercase" required></div>
                            <div><label class="text-xs font-bold">Modelo</label><input type="text" id="inv-model" class="input-std uppercase" required></div>
                            <div><label class="text-xs font-bold">Nº Série</label><input type="text" id="inv-serial" class="input-std uppercase" required></div>
                            <div><label class="text-xs font-bold">Tag/Patrimônio</label><input type="text" id="inv-tag" class="input-std uppercase"></div>
                            <div class="sm:col-span-2"><label class="text-xs font-bold">Setor</label><input type="text" id="inv-sector" class="input-std uppercase" required></div>
                            <button type="submit" class="sm:col-span-2 bg-gray-700 text-white px-4 py-3 md:py-2 rounded font-bold w-full hover:bg-gray-800 mt-2">Salvar Equipamento</button>
                        </form>
                    </div>
                    <div id="inv-feedback" class="hidden bg-green-100 text-green-800 p-2 rounded text-xs text-center font-bold mb-4">Equipamento Salvo!</div>
                </div>
            </div>
        </div>

    </main>

    <!-- Template Oculto para Grupo de Teste (Atualizado com Seleção de Padrão Específico) -->
    <template id="tpl-test-group">
        <div class="form-section group-container relative" data-group-id="">
            <button type="button" class="absolute top-2 right-2 text-red-500 text-xs hover:underline btn-remove-group bg-white p-1 rounded border border-red-100">Remover Grupo</button>
            
            <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 mb-4 bg-gray-50 p-3 rounded mt-6 md:mt-0">
                <!-- Linha 0: Padrão Específico (NOVO) -->
                <div class="sm:col-span-2">
                    <label class="text-xs font-bold text-blue-700">Padrão Utilizado neste Teste</label>
                    <select class="input-std group-std-selector bg-blue-50 border-blue-200">
                        <option value="">Selecione um padrão...</option>
                    </select>
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs font-bold text-blue-700">Variável/Função do Padrão</label>
                    <input type="text" class="input-std group-var-selector bg-blue-50 border-blue-200" placeholder="Ex: Tensão AC, Pressão Positiva">
                </div>

                <!-- Linha 1: Identificação Básica -->
                <div class="sm:col-span-2">
                    <label class="text-xs font-bold">Nome do Teste</label>
                    <input type="text" class="input-std group-name" placeholder="Ex: PRECISÃO DA ENERGIA (J)">
                </div>
                <div>
                    <label class="text-xs font-bold">Unidade</label>
                    <input type="text" class="input-std group-unit" placeholder="Ex: J, mL, mmHg">
                </div>
                <div>
                    <label class="text-xs font-bold">Resolução do Padrão</label>
                    <input type="text" class="input-std group-res" placeholder="Ex: 1">
                </div>

                <!-- Linha 2: Faixa de Uso e Capacidade -->
                <div class="sm:col-span-2">
                    <label class="text-xs font-bold block mb-1">Faixa de Uso (Min/Max)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" class="input-std group-range-min w-full" placeholder="Min (Ex: 10)">
                        <span class="text-sm text-gray-500 font-medium">até</span>
                        <input type="text" class="input-std group-range-max w-full" placeholder="Max (Ex: 200)">
                    </div>
                </div>
                <div class="sm:col-span-2">
                    <label class="text-xs font-bold block mb-1">Capacidade (Min/Max)</label>
                    <div class="flex items-center gap-2">
                        <input type="text" class="input-std group-cap-min w-full" placeholder="Min (Ex: 0)">
                        <span class="text-sm text-gray-500 font-medium">até</span>
                        <input type="text" class="input-std group-cap-max w-full" placeholder="Max (Ex: 300)">
                    </div>
                </div>

                <!-- Linha 3: Confiabilidade e Erro -->
                <div class="sm:col-span-2">
                    <label class="text-xs font-bold">Fator de Confiabilidade</label>
                    <select class="input-std group-k-factor">
                        <option value="k_2">Utilizar k = 2 (Padrão)</option>
                        <option value="calc_80">Calcular k para 80%</option>
                        <option value="calc_90">Calcular k para 90%</option>
                        <option value="calc_95">Calcular k para 95%</option>
                        <option value="calc_95_45">Calcular k para 95,45%</option>
                        <option value="calc_98">Calcular k para 98%</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold">Tipo Erro Máx.</label>
                    <select class="input-std group-err-type">
                        <option value="percent">Percentual (%)</option>
                        <option value="absolute">Valor Absoluto (Fixo)</option>
                    </select>
                </div>
                <div>
                    <label class="text-xs font-bold">Valor Erro Máx.</label>
                    <input type="number" step="0.01" class="input-std group-err-val" placeholder="Ex: 15">
                </div>
            </div>

            <!-- Tabela de Pontos com Scroll -->
            <div class="overflow-x-auto border border-gray-100 rounded">
                <table class="w-full text-xs text-left points-table min-w-[600px]">
                    <thead class="bg-gray-100 text-gray-600">
                        <tr>
                            <th class="p-2 w-20">Nominal</th>
                            <th class="p-2 w-20">Medido</th>
                            <th class="p-2 w-20">Incerteza (U)</th>
                            <th class="p-2 w-20 text-gray-400">Tendência</th>
                            <th class="p-2 w-20 text-gray-400">Teste (|E|+U)</th>
                            <th class="p-2 w-20 text-gray-400">Limite</th>
                            <th class="p-2 w-20">Status</th>
                            <th class="p-2 w-10"></th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <button type="button" class="mt-2 text-xs font-bold text-blue-600 hover:underline btn-add-point p-2">+ Adicionar Ponto de Medição</button>
        </div>
    </template>

    <script type="module">
        import { initializeApp, getApp, getApps } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, limit, where } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { CalibrationCalculator } from './calibration-logic.js';
        import { generateCalibrationCertificate } from './laudo-generator.js';

        const firebaseConfig = {
            apiKey: "",
            authDomain: "ordem-de-servicos---bm-medical.firebaseapp.com",
            projectId: "ordem-de-servicos---bm-medical",
            storageBucket: "ordem-de-servicos---bm-medical.firebasestorage.app",
            messagingSenderId: "92355637827",
            appId: "1:92355637827:web:850b89afa5054781475af6"
        };

        const app = getApps().length > 0 ? getApp() : initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let standardsList = []; 
        let equipmentInventory = []; 

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`tab-${tab}`);
            if (btn) btn.classList.add('active');
            ['dashboard', 'new', 'standards'].forEach(t => {
                const el = document.getElementById(`view-${t}`);
                if (el) el.classList.toggle('hidden', t !== tab);
            });
        };

        document.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('dateExec');
            if (dateInput) dateInput.valueAsDate = new Date();
            
            loadStandards();
            loadEquipmentInventory(); 

            const btnAddGroup = document.getElementById('btn-add-group');
            if (btnAddGroup) btnAddGroup.addEventListener('click', () => addTestGroup());

            const btnPreview = document.getElementById('btn-preview-pdf');
            if (btnPreview) {
                btnPreview.addEventListener('click', (e) => {
                    const data = collectFormData();
                    if (!validateData(data)) return;
                    generateCalibrationCertificate(data, e.target);
                });
            }

            // --- Lógica de Busca de Equipamento (Aba Novo Laudo) ---
            document.getElementById('btn-search-equip').addEventListener('click', performEquipSearch);
            document.getElementById('btn-manual-equip').addEventListener('click', enableManualEntry);
            document.getElementById('btn-clear-equip').addEventListener('click', resetEquipSearch);

            // --- Atualização de Padrões Dinâmicos ---
            document.getElementById('standards-select').addEventListener('change', updateAllGroupStandardSelects);

            // --- Salvar Padrão ---
            const formStd = document.getElementById('standard-form');
            if (formStd) {
                formStd.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('std-name').value;
                    const cert = document.getElementById('std-cert').value;
                    const valid = document.getElementById('std-validity').value;
                    try {
                        await addDoc(collection(db, 'calibration_standards'), { name, certNo: cert, validity: valid, createdAt: new Date() });
                        alert("Padrão salvo!");
                        e.target.reset();
                        loadStandards();
                    } catch(err) { console.error(err); alert("Erro ao salvar padrão."); }
                });
            }

            // --- Salvar Equipamento (Inventário) ---
            const formEquip = document.getElementById('equipment-form');
            if (formEquip) {
                formEquip.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const equipData = {
                        name: document.getElementById('inv-name').value.toUpperCase(),
                        brand: document.getElementById('inv-brand').value.toUpperCase(),
                        model: document.getElementById('inv-model').value.toUpperCase(),
                        serial: document.getElementById('inv-serial').value.toUpperCase(),
                        tag: document.getElementById('inv-tag').value.toUpperCase(),
                        sector: document.getElementById('inv-sector').value.toUpperCase(),
                        contractId: 'heufpel', 
                        createdAt: new Date()
                    };
                    try {
                        await addDoc(collection(db, 'client_equipment'), equipData);
                        const fb = document.getElementById('inv-feedback');
                        fb.classList.remove('hidden');
                        setTimeout(() => fb.classList.add('hidden'), 3000);
                        e.target.reset();
                        loadEquipmentInventory(); 
                    } catch(err) { console.error(err); alert("Erro ao salvar equipamento."); }
                });
            }
        });

        // --- Funções Auxiliares de Padrões ---
        function updateAllGroupStandardSelects() {
            // Pega os padrões selecionados no Select Principal (Aba 2)
            const mainSelect = document.getElementById('standards-select');
            const selectedOptions = Array.from(mainSelect.selectedOptions);
            
            // Atualiza todos os selects de grupo
            document.querySelectorAll('.group-std-selector').forEach(groupSelect => {
                const currentVal = groupSelect.value; // Tenta manter a seleção
                groupSelect.innerHTML = '<option value="">Selecione um padrão...</option>';
                
                selectedOptions.forEach(opt => {
                    const newOpt = document.createElement('option');
                    newOpt.value = opt.value; // ID do padrão
                    newOpt.textContent = opt.textContent;
                    groupSelect.appendChild(newOpt);
                });
                
                groupSelect.value = currentVal; // Restaura se possível
            });
        }

        // --- Funções de Busca ---
        async function loadEquipmentInventory() {
            try {
                const q = query(collection(db, 'client_equipment'));
                const snap = await getDocs(q);
                equipmentInventory = snap.docs.map(d => d.data());
            } catch (e) { console.error("Erro ao carregar inventário", e); }
        }

        function performEquipSearch() {
            const sName = document.getElementById('s-name').value.toUpperCase();
            const sBrand = document.getElementById('s-brand').value.toUpperCase();
            const sSerial = document.getElementById('s-serial').value.toUpperCase();
            
            if (!sName && !sBrand && !sSerial) { alert("Preencha ao menos um campo."); return; }

            const results = equipmentInventory.filter(eq => {
                const matchName = !sName || (eq.name && eq.name.includes(sName));
                const matchBrand = !sBrand || ((eq.brand && eq.brand.includes(sBrand)) || (eq.model && eq.model.includes(sBrand)));
                const matchSerial = !sSerial || (eq.serial && eq.serial.includes(sSerial));
                return matchName && matchBrand && matchSerial;
            });

            const resDiv = document.getElementById('equip-search-results');
            resDiv.innerHTML = '';
            resDiv.classList.remove('hidden');

            if (results.length === 0) {
                resDiv.innerHTML = '<div class="p-2 text-red-500 text-sm">Nenhum equipamento encontrado.</div>';
                return;
            }

            results.forEach(eq => {
                const row = document.createElement('div');
                row.className = "search-result-item p-2 border-b text-sm flex justify-between";
                row.innerHTML = `<span><strong>${eq.name}</strong> - ${eq.brand}/${eq.model} (S/N: ${eq.serial})</span><span class="text-blue-600 font-bold">Selecionar</span>`;
                row.addEventListener('click', () => selectEquipment(eq));
                resDiv.appendChild(row);
            });
        }

        function selectEquipment(eq) {
            document.getElementById('f-name').value = eq.name || '';
            document.getElementById('f-brand').value = eq.brand || '';
            document.getElementById('f-model').value = eq.model || '';
            document.getElementById('f-serial').value = eq.serial || '';
            document.getElementById('f-tag').value = eq.tag || '';
            document.getElementById('f-sector').value = eq.sector || '';

            ['f-name','f-brand','f-model','f-serial','f-tag','f-sector'].forEach(id => {
                const el = document.getElementById(id);
                el.setAttribute('readonly', true);
                el.classList.add('bg-gray-100');
            });

            document.getElementById('equip-search-panel').classList.add('hidden');
            document.getElementById('equip-search-results').classList.add('hidden');
            document.getElementById('equip-details-container').classList.remove('hidden');
            document.getElementById('btn-manual-equip').parentElement.classList.add('hidden');
        }

        function enableManualEntry() {
            resetEquipSearch();
            document.getElementById('equip-search-panel').classList.add('hidden');
            document.getElementById('equip-details-container').classList.remove('hidden');
            document.getElementById('btn-manual-equip').parentElement.classList.add('hidden');
            
            ['f-name','f-brand','f-model','f-serial','f-tag','f-sector'].forEach(id => {
                const el = document.getElementById(id);
                el.removeAttribute('readonly');
                el.classList.remove('bg-gray-100');
                el.value = '';
            });
        }

        function resetEquipSearch() {
            document.getElementById('equip-details-container').classList.add('hidden');
            document.getElementById('equip-search-panel').classList.remove('hidden');
            document.getElementById('equip-search-results').classList.add('hidden');
            document.getElementById('btn-manual-equip').parentElement.classList.remove('hidden');
            
            ['f-name','f-brand','f-model','f-serial','f-tag','f-sector'].forEach(id => document.getElementById(id).value = '');
        }

        // --- Lógica de Grupos de Teste ---
        function addTestGroup() {
            const container = document.getElementById('test-groups-container');
            const tpl = document.getElementById('tpl-test-group');
            const clone = tpl.content.cloneNode(true);
            const groupEl = clone.querySelector('.group-container');
            
            groupEl.querySelector('.btn-remove-group').addEventListener('click', () => groupEl.remove());
            groupEl.querySelector('.btn-add-point').addEventListener('click', () => addPointRow(groupEl.querySelector('tbody'), groupEl));
            addPointRow(groupEl.querySelector('tbody'), groupEl);
            container.appendChild(groupEl);
            
            // Popula o select de padrão deste novo grupo
            updateAllGroupStandardSelects();
        }

        function addPointRow(tbody, groupEl) {
            const row = document.createElement('tr');
            row.className = "border-b border-gray-100 hover:bg-gray-50";
            row.innerHTML = `
                <td class="p-2"><input type="number" step="0.01" class="input-std w-full val-nominal" placeholder="0"></td>
                <td class="p-2"><input type="number" step="0.01" class="input-std w-full val-measured" placeholder="0"></td>
                <td class="p-2"><input type="number" step="0.01" class="input-std w-full val-uncertainty" placeholder="0"></td>
                <td class="p-2 font-mono text-gray-600 calc-bias">-</td>
                <td class="p-2 font-mono text-gray-600 calc-test">-</td>
                <td class="p-2 font-mono text-gray-600 calc-limit">-</td>
                <td class="p-2 font-bold calc-status">-</td>
                <td class="p-2 text-center"><button type="button" class="text-red-400 hover:text-red-600">×</button></td>
            `;
            row.querySelector('button').addEventListener('click', () => row.remove());
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => input.addEventListener('input', () => recalculateRow(row, groupEl)));
            groupEl.querySelector('.group-err-type').addEventListener('change', () => recalculateRow(row, groupEl));
            groupEl.querySelector('.group-err-val').addEventListener('input', () => recalculateRow(row, groupEl));
            tbody.appendChild(row);
        }

        function recalculateRow(row, groupEl) {
            const nominal = row.querySelector('.val-nominal').value;
            const measured = row.querySelector('.val-measured').value;
            const uncertainty = row.querySelector('.val-uncertainty').value;
            const errType = groupEl.querySelector('.group-err-type').value;
            const errVal = groupEl.querySelector('.group-err-val').value;

            const bias = CalibrationCalculator.calculateBias(nominal, measured);
            row.querySelector('.calc-bias').textContent = bias !== null ? bias : '-';

            const maxErr = CalibrationCalculator.calculateMaxError(nominal, errType, errVal);
            row.querySelector('.calc-limit').textContent = maxErr !== null ? maxErr : '-';

            const testVal = CalibrationCalculator.calculateTestValue(bias, uncertainty);
            row.querySelector('.calc-test').textContent = testVal !== null ? testVal : '-';

            const status = CalibrationCalculator.evaluateStatus(testVal, maxErr);
            const statusEl = row.querySelector('.calc-status');
            statusEl.textContent = status;
            
            if (status === 'Aprovado') statusEl.className = 'p-2 font-bold text-green-600 calc-status';
            else if (status === 'Reprovado') statusEl.className = 'p-2 font-bold text-red-600 calc-status';
            else statusEl.className = 'p-2 font-bold text-gray-400 calc-status';

            updateFinalStatus();
        }

        function updateFinalStatus() {
            const allStatuses = Array.from(document.querySelectorAll('.calc-status')).map(el => el.textContent);
            const finalEl = document.getElementById('final-status-display');
            if (allStatuses.includes('Reprovado')) {
                finalEl.textContent = "REPROVADO";
                finalEl.className = "text-xl font-bold text-red-600";
            } else if (allStatuses.every(s => s === 'Aprovado')) {
                finalEl.textContent = "APROVADO";
                finalEl.className = "text-xl font-bold text-green-600";
            } else {
                finalEl.textContent = "PENDENTE";
                finalEl.className = "text-xl font-bold text-gray-500";
            }
        }

        function collectFormData() {
            const form = document.getElementById('calibration-form');
            const formData = new FormData(form);
            const stdSelect = document.getElementById('standards-select');
            const selectedStdIds = Array.from(stdSelect.selectedOptions).map(opt => opt.value);
            const selectedStandards = standardsList.filter(s => selectedStdIds.includes(s.id));

            const testGroups = [];
            document.querySelectorAll('.group-container').forEach(groupEl => {
                const points = [];
                groupEl.querySelectorAll('tbody tr').forEach(row => {
                    points.push({
                        nominal: row.querySelector('.val-nominal').value,
                        measured: row.querySelector('.val-measured').value,
                        uncertainty: row.querySelector('.val-uncertainty').value,
                        bias: row.querySelector('.calc-bias').textContent,
                        testValue: row.querySelector('.calc-test').textContent,
                        maxError: row.querySelector('.calc-limit').textContent,
                        status: row.querySelector('.calc-status').textContent
                    });
                });
                
                // Pega o padrão específico deste grupo (se selecionado)
                const groupStdId = groupEl.querySelector('.group-std-selector').value;
                const groupStd = standardsList.find(s => s.id === groupStdId);

                testGroups.push({
                    name: groupEl.querySelector('.group-name').value,
                    unit: groupEl.querySelector('.group-unit').value,
                    resolution: groupEl.querySelector('.group-res').value,
                    rangeMin: groupEl.querySelector('.group-range-min').value, 
                    rangeMax: groupEl.querySelector('.group-range-max').value, 
                    capMin: groupEl.querySelector('.group-cap-min').value, 
                    capMax: groupEl.querySelector('.group-cap-max').value, 
                    kFactor: groupEl.querySelector('.group-k-factor').value, 
                    errorType: groupEl.querySelector('.group-err-type').value,
                    errorValue: groupEl.querySelector('.group-err-val').value,
                    specificStandard: groupStd, // Novo campo
                    variableName: groupEl.querySelector('.group-var-selector').value, // Novo campo
                    points: points
                });
            });

            const dateExec = formData.get('dateExec'); 
            const months = parseInt(document.getElementById('validityMonths').value);
            const dateObj = new Date(dateExec);
            dateObj.setMonth(dateObj.getMonth() + months);
            const dateValid = dateObj.toISOString().split('T')[0];

            return {
                clientName: "EBSERH / HE-UFPEL",
                requester: formData.get('requester'),
                equipName: formData.get('equipName'),
                equipBrand: formData.get('equipBrand'),
                equipModel: formData.get('equipModel'),
                equipSerial: formData.get('equipSerial'),
                equipTag: formData.get('equipTag'),
                envTemp: formData.get('envTemp'),
                envHum: formData.get('envHum'),
                dateExec,
                dateValid,
                standards: selectedStandards,
                testGroups,
                finalStatus: document.getElementById('final-status-display').textContent,
                certificateNumber: "Automático" 
            };
        }

        function validateData(data) {
            if (!data.equipName || !data.equipSerial) { alert("Preencha os dados do equipamento."); return false; }
            if (data.testGroups.length === 0) { alert("Adicione pelo menos um grupo de testes."); return false; }
            return true;
        }

        async function loadStandards() {
            const select = document.getElementById('standards-select');
            const tbody = document.getElementById('standards-list-body');
            if(!select || !tbody) return;

            select.innerHTML = '';
            tbody.innerHTML = '';
            
            try {
                const snap = await getDocs(collection(db, 'calibration_standards'));
                standardsList = [];
                snap.forEach(doc => {
                    const std = { id: doc.id, ...doc.data() };
                    standardsList.push(std);
                    const opt = document.createElement('option');
                    opt.value = std.id;
                    opt.textContent = `${std.name} (Val: ${std.validity})`;
                    select.appendChild(opt);
                    const row = document.createElement('tr');
                    row.className = "border-b";
                    row.innerHTML = `<td class="p-2">${std.name}</td><td class="p-2">${std.validity}</td><td class="p-2 text-red-500 cursor-pointer">Excluir</td>`;
                    tbody.appendChild(row);
                });
            } catch(e) { console.error("Erro ao carregar padrões:", e); }
        }
    </script>
</body>
</html>